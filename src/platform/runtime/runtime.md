# runtime

## 综述
该目录包含 10 个文件与 0 个子目录，直接文件类型以 .js、.md 为主，用于承载本层级的实现与配置。

## 文件列表
- agent_manager.js: 功能：实现模块逻辑。责任：为上层提供可复用能力或入口。内部结构：头部说明“智能体管理器模块 本模块负责智能体的生命周期管理，是 Runtime 的子模块之一。 【设计初衷】 智能体是系统的核心执行单元，需要统一管理其创建、注册、状态跟踪和终止。 将这些功能集中到一个模块，便于维护智能体的一致性和完整性。 【主要功能】 1. 创建和注册智能体实例 2. 管理智能体的父子关系 3. 跟踪智能体的活动状态 4. 终止智能体（包括级联终止子智能体） 5. 从持久化状态恢复智能体 【智能体生命周期】 1. 创建：通过 ”，导出符号：AgentManager。
- browser_javascript_executor.js: 功能：实现模块逻辑。责任：为上层提供可复用能力或入口。内部结构：头部说明“浏览器 JavaScript 执行器模块 本模块负责在 headless Chrome 浏览器中执行用户提供的 JavaScript 代码。 【设计初衷】 智能体在处理任务时，经常需要执行 JavaScript 代码进行计算、数据处理、Canvas 绘图等操作。 通过在真实浏览器环境中执行代码，可以获得完整的浏览器 API 支持，避免 Node.js 环境下的兼容性问题。 【主要功能】 1. 在 headless Chrome 中执行 ”，导出符号：BrowserJavaScriptExecutor。
- context_builder.js: 功能：实现模块逻辑。责任：为上层提供可复用能力或入口。内部结构：头部说明“上下文构建器模块 本模块负责构建智能体执行所需的各种上下文信息，是 Runtime 的子模块之一。 【设计初衷】 智能体在处理消息时需要各种上下文信息：系统提示词、消息格式化、会话历史等。 将这些上下文构建逻辑集中到一个模块，便于维护和扩展。 【主要功能】 1. 构建智能体的系统提示词（包含岗位职责、任务委托书、联系人等） 2. 格式化消息为 LLM 可理解的文本 3. 管理会话上下文 4. 构建智能体执行上下文对象 【使用流程】 1.”，导出符号：ContextBuilder。
- index.js: 功能：实现模块逻辑。责任：为上层提供可复用能力或入口。内部结构：头部说明“Runtime 子模块索引文件 本目录包含 Runtime 类拆分后的各个子模块： - javascript_executor.js - JavaScript 代码执行器 - context_builder.js - 上下文构建器 - agent_manager.js - 智能体管理器 - message_processor.js - 消息处理器 - tool_executor.js - 工具执行器 - llm_handler.js -”，导出符号：（未匹配到明显的导出符号）。
- javascript_executor.js: 功能：实现模块逻辑。责任：为上层提供可复用能力或入口。内部结构：头部说明“JavaScript 执行器模块 本模块负责安全执行用户提供的 JavaScript 代码，是 Runtime 的子模块之一。 【设计初衷】 智能体在处理任务时，经常需要进行精确计算、数据转换、日期处理等操作。 由于 LLM 在数值计算方面不够可靠，因此提供一个安全的 JavaScript 执行环境， 让智能体可以通过代码来完成这些需要精确结果的任务。 【主要功能】 1. 执行用户提供的 JavaScript 代码 2. 检测并阻止危险”，导出符号：JavaScriptExecutor。
- llm_handler.js: 功能：实现模块逻辑。责任：为上层提供可复用能力或入口。内部结构：头部说明“LLM 处理器模块 本模块负责与 LLM 的交互，是 Runtime 的子模块之一。 【设计初衷】 智能体的核心能力来自 LLM，需要一个专门的模块来： - 管理与 LLM 的通信 - 处理工具调用循环 - 处理 LLM 错误和中断 【主要功能】 1. 处理消息并调用 LLM 2. 管理工具调用循环 3. 处理 LLM 错误和中断 4. 向父智能体发送错误通知 5. 支持多模态消息（图片附件） 【处理流程】 1. 检查上下文限制 2. ”，导出符号：LlmHandler。
- message_processor.js: 功能：实现模块逻辑。责任：为上层提供可复用能力或入口。内部结构：头部说明“消息处理器模块 本模块负责消息的调度和处理，是 Runtime 的子模块之一。 【设计初衷】 智能体之间通过消息进行通信，需要一个统一的消息处理机制来： - 调度消息到正确的智能体 - 控制并发处理数量 - 确保消息处理的可靠性 【主要功能】 1. 消息处理循环（生产者-消费者模式） 2. 并发控制（限制同时处理的消息数量） 3. 单智能体串行约束（同一智能体的消息串行处理） 4. 消息投递和处理 【处理模式】 - 生产者-消费者模式：”，导出符号：MessageProcessor。
- runtime.md: 功能：本目录说明文档。责任：描述目录综述、文件列表与子目录列表。内部结构：包含“综述 / 文件列表 / 子目录列表”三部分。
- shutdown_manager.js: 功能：实现模块逻辑。责任：为上层提供可复用能力或入口。内部结构：头部说明“关闭管理器模块 本模块负责系统的优雅关闭流程，是 Runtime 的子模块之一。 【设计初衷】 系统关闭时需要确保： - 正在处理的消息能够完成 - 状态能够正确持久化 - 资源能够正确释放 【主要功能】 1. 设置优雅关闭处理（监听 SIGINT/SIGTERM） 2. 执行关闭流程 3. 提供关闭状态查询 【关闭流程】 1. 停止接收新消息 2. 等待当前处理完成（有超时限制） 3. 持久化组织状态 4. 持久化对话历史 5. 关闭”，导出符号：ShutdownManager。
- tool_executor.js: 功能：实现模块逻辑。责任：为上层提供可复用能力或入口。内部结构：头部说明“工具执行器模块 本模块负责定义和执行所有工具，是 Runtime 的子模块之一。 【设计初衷】 智能体通过工具与外部世界交互，需要一个统一的模块来： - 定义所有可用工具的 schema - 执行工具调用 - 处理工具执行错误 【主要功能】 1. 定义工具 schema（OpenAI tools 格式） 2. 执行工具调用 3. 处理特殊工具（spawn_agent_with_task、compress_context 等） 【工具分类”，导出符号：ToolExecutor。

## 子目录列表
- （无）
