# SSH模块

## 模块概述

SSH模块为agent society系统提供SSH远程操作能力，使智能体能够通过SSH协议连接和操作远程服务器。

## 核心功能

### 1. 连接管理
- 列出已配置的主机
- 建立SSH连接（支持密码和密钥认证）
- 管理多个并发连接
- 断开连接和资源清理

### 2. 交互式Shell会话
- 创建持久化的shell会话
- 异步发送命令（立即返回，不阻塞）
- 窗口读取输出（支持偏移位置读取）
- 输出保存到本地文件，无大小限制

### 3. 文件传输
- 异步上传文件到远程服务器
- 异步下载文件到本地工件系统
- 传输进度跟踪
- 支持取消传输任务

## 架构设计

### 模块结构
```
modules/ssh/
├── index.js              # 模块入口，路由和生命周期管理
├── connection_manager.js # 连接管理器
├── shell_manager.js      # Shell会话管理器
├── file_transfer.js      # 文件传输管理器
├── tools.js              # 工具定义
├── ssh.md                # 模块说明（本文件）
├── README.md             # 使用指南
├── CONFIG.md             # 配置说明
└── CHANGELOG.md          # 变更日志
```

### 职责划分

**index.js（模块入口）**
- 模块初始化和配置
- 工具调用路由分发
- 子模块实例管理
- 模块生命周期管理

**ConnectionManager（连接管理器）**
- SSH连接的建立、维护和关闭
- 连接池管理
- 连接认证（密码、密钥）
- 连接状态监控

**ShellManager（Shell会话管理器）**
- 创建和管理交互式shell会话
- 异步接收会话输出并保存到本地文件
- 提供文件偏移读取功能
- 会话生命周期管理

**FileTransfer（文件传输）**
- SFTP连接管理
- 异步文件上传和下载
- 传输任务管理和进度跟踪
- 定期清理已完成任务

## 工具列表

### 连接管理
- `ssh_list_hosts` - 列出已配置的主机
- `ssh_connect` - 建立SSH连接
- `ssh_disconnect` - 断开SSH连接
- `ssh_list_connections` - 列出所有活动连接

### 交互式会话
- `ssh_shell_create` - 创建交互式shell会话
- `ssh_shell_send` - 发送命令到会话（异步）
- `ssh_shell_read` - 读取会话输出窗口
- `ssh_shell_close` - 关闭shell会话

### 文件传输
- `ssh_upload` - 上传文件（异步）
- `ssh_download` - 下载文件（异步）
- `ssh_transfer_status` - 查询传输状态
- `ssh_transfer_cancel` - 取消传输任务

## 设计特点

### 1. 安全性
- 认证信息存储在配置文件中，对智能体透明
- 智能体只能看到主机名称，无法获取IP、端口、认证信息
- 不在日志中记录敏感信息

### 2. 异步设计
- Shell命令发送立即返回，不等待执行完成
- 文件传输在后台执行，不阻塞工具调用
- 通过轮询查询状态和结果

### 3. 资源管理
- 连接池管理，支持多连接并发
- 自动清理已完成的传输任务
- 模块关闭时自动清理所有资源

### 4. 错误处理
- 完整的错误分类和友好的错误信息
- 详细的日志记录供开发人员调试
- 错误不扩散，保护系统稳定性

### 5. 兼容性
- 使用ES模块语法
- 使用`node:` 前缀导入内置模块
- 兼容Bun和Node.js运行时

## 使用场景

### 场景1：执行远程命令
智能体需要在远程服务器上执行命令并获取结果。

**流程：**
1. 列出可用主机
2. 建立连接
3. 创建shell会话
4. 发送命令
5. 读取输出
6. 关闭会话
7. 断开连接

### 场景2：部署应用
智能体需要将本地文件上传到远程服务器并执行部署脚本。

**流程：**
1. 建立连接
2. 上传文件
3. 查询上传状态
4. 创建shell会话
5. 执行部署脚本
6. 读取执行结果
7. 清理资源

### 场景3：日志收集
智能体需要从远程服务器下载日志文件进行分析。

**流程：**
1. 建立连接
2. 创建shell会话
3. 查找日志文件
4. 下载日志文件
5. 查询下载状态
6. 分析日志内容
7. 清理资源

## 性能考虑

### 连接复用
- 同一主机的多次操作复用连接
- 避免频繁建立和断开连接

### 并发控制
- 支持多连接并发操作
- 单连接内串行执行命令

### 内存管理
- 输出通过窗口读取，避免内存溢出
- 文件传输使用流式处理
- 及时释放不再使用的资源

## 限制和约束

### 当前不支持
- 端口转发和隧道功能
- X11转发
- SSH代理功能
- 断点续传

### 配置限制
- 最大连接数：可配置（默认10）
- 连接超时：可配置（默认30秒）
- 输出窗口大小：5000字符（固定）

## 未来计划

### 短期
- 完善单元测试
- 性能优化
- 连接保活机制
- 空闲超时清理

### 长期
- 支持端口转发
- 支持SSH代理跳转
- 文件传输断点续传
- Web管理界面

## 参考资料

- [SSH协议规范](https://datatracker.ietf.org/doc/html/rfc4251)
- [ssh2库文档](https://github.com/mscdex/ssh2)
- [设计文档](.kiro/specs/ssh-module/design.md)
- [需求文档](.kiro/specs/ssh-module/requirements.md)
