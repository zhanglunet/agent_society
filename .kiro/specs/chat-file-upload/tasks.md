# Implementation Plan: Chat File Upload

## Overview

æœ¬å®ç°è®¡åˆ’å°†èŠå¤©æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½åˆ†è§£ä¸ºå¯æ‰§è¡Œçš„ç¼–ç ä»»åŠ¡ã€‚æŒ‰ç…§å‰ç«¯ç»„ä»¶ â†’ åç«¯API â†’ é›†æˆçš„é¡ºåºå®ç°ï¼Œç¡®ä¿æ¯ä¸ªæ­¥éª¤éƒ½å¯ä»¥ç‹¬ç«‹æµ‹è¯•ã€‚

## Tasks

- [x] 1. åˆ›å»ºå‰ç«¯å›¾ç‰‡è½¬æ¢å™¨æ¨¡å—
  - [x] 1.1 åˆ›å»º `web/js/utils/image-converter.js` æ–‡ä»¶
    - å®ç° `convertToJpeg(file, quality)` æ–¹æ³•ï¼Œä½¿ç”¨ Canvas API è½¬æ¢å›¾ç‰‡æ ¼å¼
    - å®ç° `isSupportedImage(file)` å¼‚æ­¥æ–¹æ³•ï¼Œé€šè¿‡å°è¯•åŠ è½½å›¾ç‰‡éªŒè¯æµè§ˆå™¨æ”¯æŒ
    - å®ç° `isJpeg(file)` æ–¹æ³•ï¼Œæ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸º JPEG æ ¼å¼
    - _Requirements: 1.3, 3.1, 3.2, 3.3, 3.4_
  - [x] 1.2 ç¼–å†™å›¾ç‰‡è½¬æ¢å™¨å±æ€§æµ‹è¯•
    - **Property 1: Image Conversion Produces Valid JPEG**
    - **Validates: Requirements 1.3, 3.1, 3.2, 3.3**

- [x] 2. åˆ›å»ºå‰ç«¯ä¸Šä¼ æœåŠ¡æ¨¡å—
  - [x] 2.1 åˆ›å»º `web/js/utils/upload-service.js` æ–‡ä»¶
    - å®ç° `upload(file, options)` æ–¹æ³•ï¼Œæ”¯æŒè¿›åº¦å›è°ƒ
    - å®ç° `uploadAll(files)` æ–¹æ³•ï¼Œæ‰¹é‡ä¸Šä¼ 
    - ä½¿ç”¨ XMLHttpRequest æ”¯æŒä¸Šä¼ è¿›åº¦
    - _Requirements: 5.1, 8.1, 8.2_
  - [x] 2.2 ç¼–å†™ä¸Šä¼ æœåŠ¡å•å…ƒæµ‹è¯•
    - æµ‹è¯•ä¸Šä¼ æˆåŠŸåœºæ™¯
    - æµ‹è¯•ä¸Šä¼ å¤±è´¥åœºæ™¯
    - æµ‹è¯•è¿›åº¦å›è°ƒ
    - _Requirements: 8.1, 8.2, 8.3_

- [x] 3. åˆ›å»ºå‰ç«¯é™„ä»¶ç®¡ç†å™¨æ¨¡å—
  - [x] 3.1 åˆ›å»º `web/js/components/attachment-manager.js` æ–‡ä»¶
    - å®ç°é™„ä»¶åˆ—è¡¨çŠ¶æ€ç®¡ç†ï¼ˆadd, remove, clear, getArtifactRefsï¼‰
    - å®ç°é™„ä»¶çŠ¶æ€è·Ÿè¸ªï¼ˆpending, uploading, ready, errorï¼‰
    - å®ç°é¢„è§ˆåŒºåŸŸæ¸²æŸ“
    - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_
  - [x] 3.2 ç¼–å†™é™„ä»¶ç®¡ç†å™¨å±æ€§æµ‹è¯•
    - **Property 8: Attachment Removal Decreases Count**
    - **Property 9: Send Clears All Attachments**
    - **Validates: Requirements 7.3, 7.5**

- [x] 4. å®ç°åç«¯æ–‡ä»¶ä¸Šä¼  API
  - [x] 4.1 åœ¨ `src/platform/http_server.js` ä¸­æ·»åŠ  POST /api/upload ç«¯ç‚¹
    - è§£æ multipart/form-data è¯·æ±‚
    - éªŒè¯æ–‡ä»¶å¤§å°é™åˆ¶
    - è°ƒç”¨ Artifact_Store ä¿å­˜æ–‡ä»¶
    - è¿”å› artifact å¼•ç”¨å’Œå…ƒæ•°æ®
    - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_
  - [x] 4.2 ç¼–å†™ä¸Šä¼  API å±æ€§æµ‹è¯•
    - **Property 4: File Size Validation**
    - **Property 5: Upload Success Response Format**
    - **Validates: Requirements 4.2, 4.3, 4.4, 4.5, 4.6**

- [x] 5. æ‰©å±• Artifact Store æ”¯æŒä¸Šä¼ æ–‡ä»¶
  - [x] 5.1 åœ¨ `src/platform/artifact_store.js` ä¸­æ·»åŠ  `saveUploadedFile` æ–¹æ³•
    - æ”¯æŒä¿å­˜ä»»æ„ç±»å‹æ–‡ä»¶ï¼ˆä¸ä»…æ˜¯å›¾ç‰‡ï¼‰
    - ç”Ÿæˆå®Œæ•´çš„å…ƒæ•°æ®ï¼ˆid, type, filename, size, mimeType, createdAtï¼‰
    - è¿”å› artifact å¼•ç”¨
    - _Requirements: 4.3, 4.4_

- [x] 6. Checkpoint - ç¡®ä¿ä¸Šä¼ åŠŸèƒ½æ­£å¸¸å·¥ä½œ
  - ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œå¦‚æœ‰é—®é¢˜è¯·è¯¢é—®ç”¨æˆ·

- [x] 7. æ›´æ–°èŠå¤©è¾“å…¥åŒºåŸŸ UI
  - [x] 7.1 ä¿®æ”¹ `web/index.html` æ·»åŠ ä¸Šä¼ æŒ‰é’®
    - æ·»åŠ å›¾ç‰‡ä¸Šä¼ æŒ‰é’®ï¼ˆğŸ“· å›¾æ ‡ï¼‰
    - æ·»åŠ æ–‡ä»¶ä¸Šä¼ æŒ‰é’®ï¼ˆğŸ“ å›¾æ ‡ï¼‰
    - æ·»åŠ é™„ä»¶é¢„è§ˆåŒºåŸŸå®¹å™¨
    - _Requirements: 1.1, 1.2, 2.1, 2.2_
  - [x] 7.2 ä¿®æ”¹ `web/css/style.css` æ·»åŠ ä¸Šä¼ ç›¸å…³æ ·å¼
    - ä¸Šä¼ æŒ‰é’®æ ·å¼
    - é™„ä»¶é¢„è§ˆåŒºåŸŸæ ·å¼
    - ç¼©ç•¥å›¾æ ·å¼
    - è¿›åº¦æŒ‡ç¤ºå™¨æ ·å¼
    - ç§»é™¤æŒ‰é’®æ ·å¼
    - _Requirements: 1.4, 1.5, 7.1, 7.2, 8.1_

- [x] 8. é›†æˆä¸Šä¼ åŠŸèƒ½åˆ°èŠå¤©é¢æ¿
  - [x] 8.1 ä¿®æ”¹ `web/js/components/chat-panel.js` é›†æˆé™„ä»¶åŠŸèƒ½
    - åˆå§‹åŒ– AttachmentManager
    - ç»‘å®šä¸Šä¼ æŒ‰é’®äº‹ä»¶
    - å¤„ç†å›¾ç‰‡é€‰æ‹©å’Œè½¬æ¢
    - å¤„ç†æ–‡ä»¶é€‰æ‹©
    - æ˜¾ç¤ºé™„ä»¶é¢„è§ˆ
    - ä¸Šä¼ ä¸­ç¦ç”¨å‘é€æŒ‰é’®
    - _Requirements: 1.2, 1.3, 1.4, 2.2, 2.3, 8.4_
  - [x] 8.2 ä¿®æ”¹å‘é€æ¶ˆæ¯é€»è¾‘
    - å‘é€å‰å…ˆä¸Šä¼ æ‰€æœ‰é™„ä»¶
    - æ¶ˆæ¯ payload åŒ…å« attachments æ•°ç»„
    - å‘é€æˆåŠŸåæ¸…ç©ºé™„ä»¶
    - _Requirements: 5.1, 5.2, 7.5_

- [x] 9. æ›´æ–° API æ¨¡å—æ”¯æŒä¸Šä¼ 
  - [x] 9.1 ä¿®æ”¹ `web/js/api.js` æ·»åŠ ä¸Šä¼ æ–¹æ³•
    - æ·»åŠ  `uploadFile(file, type, filename, onProgress)` æ–¹æ³•
    - æ·»åŠ  `sendMessageWithAttachments(toAgentId, message, attachments)` æ–¹æ³•
    - _Requirements: 5.1, 5.2_

- [x] 10. æ‰©å±•åç«¯æ¶ˆæ¯å¤„ç†æ”¯æŒé™„ä»¶
  - [x] 10.1 ä¿®æ”¹ `src/platform/http_server.js` çš„ /api/send ç«¯ç‚¹
    - æ”¯æŒæ¥æ”¶å¸¦ attachments çš„æ¶ˆæ¯
    - å­˜å‚¨é™„ä»¶å¼•ç”¨åˆ°æ¶ˆæ¯ payload
    - _Requirements: 5.3_
  - [x] 10.2 ç¼–å†™æ¶ˆæ¯é™„ä»¶å±æ€§æµ‹è¯•
    - **Property 6: Message Attachment References Integrity**
    - **Validates: Requirements 5.2, 5.3**

- [x] 11. Checkpoint - ç¡®ä¿æ¶ˆæ¯å‘é€æºå¸¦é™„ä»¶æ­£å¸¸å·¥ä½œ
  - ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œå¦‚æœ‰é—®é¢˜è¯·è¯¢é—®ç”¨æˆ·

- [x] 12. æ‰©å±• LLM å®¢æˆ·ç«¯æ”¯æŒå¤šæ¨¡æ€æ¶ˆæ¯
  - [x] 12.1 ä¿®æ”¹æ¶ˆæ¯æ ¼å¼åŒ–é€»è¾‘æ”¯æŒå›¾ç‰‡
    - ä¿®æ”¹ `src/platform/message_formatter.js` æˆ–ç›¸å…³æ–‡ä»¶
    - å°†å¸¦å›¾ç‰‡é™„ä»¶çš„æ¶ˆæ¯è½¬æ¢ä¸º OpenAI Vision API æ ¼å¼
    - ä» Artifact Store è¯»å–å›¾ç‰‡æ•°æ®å¹¶è½¬ä¸º base64
    - _Requirements: 6.1, 6.2_
  - [x] 12.2 ç¼–å†™ LLM å¤šæ¨¡æ€æ¶ˆæ¯å±æ€§æµ‹è¯•
    - **Property 7: LLM Request Multimodal Format**
    - **Validates: Requirements 6.1, 6.2**

- [x] 13. æ›´æ–°èŠå¤©é¢æ¿æ˜¾ç¤ºå¸¦é™„ä»¶çš„æ¶ˆæ¯
  - [x] 13.1 ä¿®æ”¹ `web/js/components/chat-panel.js` çš„æ¶ˆæ¯æ¸²æŸ“
    - æ¸²æŸ“æ¶ˆæ¯ä¸­çš„å›¾ç‰‡é™„ä»¶ç¼©ç•¥å›¾
    - æ¸²æŸ“æ¶ˆæ¯ä¸­çš„æ–‡ä»¶é™„ä»¶å›¾æ ‡å’Œæ–‡ä»¶å
    - ç‚¹å‡»å›¾ç‰‡å¯æ”¾å¤§æŸ¥çœ‹
    - _Requirements: 5.4_

- [x] 14. Final Checkpoint - å®Œæ•´åŠŸèƒ½æµ‹è¯•
  - ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡
  - æµ‹è¯•å®Œæ•´æµç¨‹ï¼šé€‰æ‹©å›¾ç‰‡ â†’ è½¬æ¢ â†’ ä¸Šä¼  â†’ å‘é€æ¶ˆæ¯ â†’ LLM å¤„ç†
  - å¦‚æœ‰é—®é¢˜è¯·è¯¢é—®ç”¨æˆ·

## Notes

- æ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯å¿…é¡»å®Œæˆçš„ï¼ŒåŒ…æ‹¬æµ‹è¯•ä»»åŠ¡
- æ¯ä¸ªä»»åŠ¡éƒ½å¼•ç”¨äº†å…·ä½“çš„éœ€æ±‚æ¡æ¬¾ä»¥ç¡®ä¿å¯è¿½æº¯æ€§
- Checkpoint ä»»åŠ¡ç”¨äºé˜¶æ®µæ€§éªŒè¯ï¼Œç¡®ä¿å¢é‡å¼€å‘çš„æ­£ç¡®æ€§
- å±æ€§æµ‹è¯•éªŒè¯é€šç”¨æ­£ç¡®æ€§å±æ€§ï¼Œå•å…ƒæµ‹è¯•éªŒè¯å…·ä½“ç¤ºä¾‹å’Œè¾¹ç•Œæƒ…å†µ
