# SSH模块需求文档

## 1. 项目概述

### 1.1 项目背景
为agent society系统增加SSH远程操作能力，使智能体能够通过SSH协议连接和操作远程服务器，执行命令、传输文件等操作。

### 1.2 项目目标
- 提供SSH连接管理能力
- 提供远程命令执行能力
- 提供文件传输能力（SFTP）
- 提供会话管理能力
- 参考chrome模块的系统集成方式

### 1.3 项目范围
**包含：**
- SSH连接的建立、维护和关闭
- 远程命令执行（交互式会话）
- 文件上传和下载（SFTP）
- 连接状态监控和错误处理

**不包含：**
- 端口转发和隧道功能
- X11转发
- SSH代理功能

## 2. 用户故事

### 2.1 连接管理
**作为**智能体  
**我想要**建立SSH连接到远程服务器  
**以便**执行后续的远程操作

**验收标准：**
- 智能体可以获取已配置的主机列表
- 智能体通过主机名称建立连接
- 主机名称是配置文件中定义的标识符
- 系统通过主机名称查找IP地址和认证信息
- 智能体无需知道IP地址、端口、用户名、密码等信息
- 连接成功返回连接ID
- 连接失败返回明确的错误信息

### 2.2 交互式会话
**作为**智能体  
**我想要**创建交互式SSH会话  
**以便**执行需要多次交互的操作

**验收标准：**
- 支持创建持久化的shell会话
- 支持在会话中异步执行命令（立即返回，不等待完成）
- 会话输出保存到本地文件，无大小限制
- 支持设置文件偏移读取窗口（窗口大小5000字符）
- 支持获取当前偏移位置和文件总长度
- 正确处理并发读写，避免冲突
- 支持关闭会话

### 2.3 文件传输
**作为**智能体  
**我想要**上传和下载文件  
**以便**在本地工件和远程服务器之间传输数据

**验收标准：**
- 支持从工件上传文件到远程服务器
- 支持从远程服务器下载文件并保存为工件
- 文件传输立即返回任务ID和文件大小，不阻塞
- 支持通过任务ID查询传输进度
- 传输完成后返回结果（成功或失败）
- 支持取消正在进行的传输任务

### 2.4 连接管理
**作为**智能体  
**我想要**管理多个SSH连接  
**以便**同时操作多台服务器

**验收标准：**
- 支持同时维护多个连接
- 支持列出所有活动连接
- 支持关闭指定连接
- 支持关闭所有连接

### 2.5 错误处理
**作为**智能体  
**我想要**收到清晰的错误信息  
**以便**理解问题并采取正确的应对措施

**验收标准：**
- 使用不存在的连接ID时返回明确错误：`连接不存在：{connectionId}`
- 在已关闭的连接上操作时返回明确错误：`连接已关闭：{connectionId}`
- 使用不存在的会话ID时返回明确错误：`Shell会话不存在：{shellId}`
- 在已关闭的会话上操作时返回明确错误：`Shell会话已关闭：{shellId}`
- 使用无效主机名称时返回明确错误：`主机名称无效：{hostName}，请使用ssh_list_hosts查看可用主机`
- 所有错误信息友好、可读、不包含敏感信息
- 错误信息包含足够的上下文帮助定位问题

## 3. 功能需求

### 3.1 连接管理
- **ssh_list_hosts**: 列出已配置的主机
  - 参数：无
  - 返回：hosts数组（包含hostName、description等信息）
  - 说明：返回配置文件中定义的所有主机名称，不包含IP、认证等敏感信息

- **ssh_connect**: 建立SSH连接
  - 参数：hostName（主机名称，必需）
  - 返回：connectionId（连接ID）、status（连接状态）
  - 说明：系统通过主机名称从配置文件查找IP地址和认证信息

- **ssh_disconnect**: 断开SSH连接
  - 参数：connectionId（连接ID）
  - 返回：status（操作状态）

- **ssh_list_connections**: 列出所有活动连接
  - 参数：无
  - 返回：connections数组（包含connectionId、hostName、status等信息）

### 3.2 交互式会话
- **ssh_shell_create**: 创建交互式shell会话
  - 参数：connectionId（连接ID）
  - 返回：shellId（会话ID）
  - 说明：输出文件由模块自动管理，对智能体透明

- **ssh_shell_send**: 在shell会话中发送命令
  - 参数：shellId（会话ID）、command（命令）
  - 返回：status（操作状态）
  - 说明：命令立即返回，不等待执行完成

- **ssh_shell_read**: 读取shell会话输出窗口
  - 参数：shellId（会话ID）、offset（文件偏移位置，字节数）
  - 返回：output（窗口内容，最多5000字符）、offset（当前偏移）、totalLength（文件总长度）
  - 说明：从指定偏移位置读取最多5000字符

- **ssh_shell_close**: 关闭shell会话
  - 参数：shellId（会话ID）
  - 返回：status（操作状态）

### 3.3 文件传输
- **ssh_upload**: 上传文件（异步）
  - 参数：connectionId（连接ID）、artifactId（工件ID）、remotePath（远程文件路径）
  - 返回：taskId（任务ID）、fileSize（文件大小，字节）、status（任务状态：pending）
  - 说明：立即返回，不等待传输完成

- **ssh_download**: 下载文件（异步）
  - 参数：connectionId（连接ID）、remotePath（远程文件路径）、fileName（文件名，用于工件命名）
  - 返回：taskId（任务ID）、fileSize（文件大小，字节）、status（任务状态：pending）
  - 说明：立即返回，不等待传输完成

- **ssh_transfer_status**: 查询传输任务状态
  - 参数：taskId（任务ID）
  - 返回：status（任务状态）、progress（传输进度）、bytesTransferred（已传输字节数）、totalBytes（总字节数）、result（完成时的结果）
  - 状态值：pending（等待中）、transferring（传输中）、completed（已完成）、failed（失败）、cancelled（已取消）

- **ssh_transfer_cancel**: 取消传输任务
  - 参数：taskId（任务ID）
  - 返回：status（操作状态）

## 4. 非功能需求

### 4.1 性能要求
- 连接建立时间：< 5秒（正常网络环境）
- 命令执行响应时间：< 1秒（不含命令本身执行时间）
- 文件传输速度：充分利用网络带宽
- 支持至少10个并发连接

### 4.2 安全要求
- 认证信息（密码、密钥）存储在配置文件中
- 大模型无法感知任何认证敏感数据
- 不在日志中明文记录密码
- 支持SSH known_hosts验证（可配置）
- 连接超时自动断开

### 4.3 可靠性要求
- 网络异常时自动重连（可配置）
- 命令执行超时保护
- 完整的错误处理和错误信息返回
- 资源泄漏保护（连接、会话自动清理）

### 4.4 可维护性要求
- 代码结构清晰，职责明确
- 完整的函数级注释
- 代码风格严谨、利落、清晰
- 模块化设计，易于扩展

### 4.5 兼容性要求
- 主要运行环境：Bun 1.3.5
- 兼容运行环境：Node.js（LTS 版本）
- 支持主流SSH服务器（OpenSSH等）
- 与现有agent society系统无缝集成
- 使用标准 ES 模块语法
- 使用 `node:` 前缀导入内置模块，确保 Bun 和 Node.js 兼容

## 5. 技术约束

### 5.1 技术栈
- 运行环境：Bun 1.3.5（主要），兼容 Node.js
- SSH库：ssh2（npm包）
- 编程语言：JavaScript（ES 模块）
- 模块系统：ES Module（`"type": "module"`）

### 5.2 架构约束
- 参考chrome模块的系统集成方式
- 遵循模块化设计原则
- 高内聚、低耦合
- 每个文件不超过500行代码
- 代码风格严谨、利落、清晰
- 使用 ES 模块语法（`import`/`export`）
- 使用 `node:` 前缀导入 Node.js 内置模块（如 `node:fs`、`node:path`）
- 兼容 Bun 和 Node.js 运行时

### 5.3 依赖约束
- 依赖ssh2库进行SSH协议实现
- 不引入其他重量级依赖

## 6. 验收标准

### 6.1 功能验收
- 所有工具定义的功能正常工作
- 错误处理完善，错误信息清晰
- 支持多连接并发操作
- 文件传输功能稳定可靠

### 6.2 代码质量验收
- 代码风格严谨、利落、清晰
- 所有函数有完整注释
- 模块职责清晰，无循环依赖
- 单个文件代码量不超过500行

### 6.3 测试验收
- 单元测试覆盖核心功能
- 集成测试验证工具调用流程
- 错误场景测试完整

### 6.4 文档验收
- 完整的模块说明文档（ssh.md）
- 工具使用示例文档
- API文档完整

## 7. 风险与依赖

### 7.1 技术风险
- SSH连接稳定性依赖网络环境
- 不同SSH服务器可能有兼容性问题
- 大文件传输可能占用较多内存

### 7.2 缓解措施
- 实现连接重试机制
- 充分测试主流SSH服务器
- 实现流式文件传输，避免内存占用过高

### 7.3 外部依赖
- ssh2库的稳定性和维护状态
- 目标SSH服务器的可用性
- 网络连接质量

## 8. 里程碑

### 8.1 阶段一：基础架构（1-2天）
- 创建模块目录结构
- 创建配置文件模板
- 实现连接管理器
- 实现基本的连接建立和断开

### 8.2 阶段二：交互式会话（1-2天）
- 实现交互式会话管理
- 实现窗口滚动查看
- 完善错误处理

### 8.3 阶段三：文件传输（1天）
- 实现SFTP功能
- 实现文件上传下载

### 8.4 阶段四：测试和文档（1天）
- 编写单元测试
- 编写集成测试
- 完善文档

## 9. 附录

### 9.1 参考资料
- ssh2库文档：https://github.com/mscdex/ssh2
- SSH协议规范：RFC 4251-4254
- chrome模块实现：modules/chrome/

### 9.2 术语表
- **SSH**: Secure Shell，安全外壳协议
- **SFTP**: SSH File Transfer Protocol，SSH文件传输协议
- **Shell会话**: 交互式命令行会话
- **连接ID**: 唯一标识一个SSH连接的字符串
- **会话ID**: 唯一标识一个Shell会话的字符串
