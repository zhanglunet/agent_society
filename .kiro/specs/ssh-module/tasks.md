# SSH模块开发任务列表

## 开发顺序说明
按照调用链顺序开发：入口 → 工具定义 → 具体模块
每完成一个小模块就接入系统测试，小步快跑

## 1. 项目准备
- [ ] 1.1 创建模块目录结构
- [ ] 1.2 安装ssh2依赖包
- [ ] 1.3 创建基础文件框架（使用 ES 模块语法）
- [ ] 1.4 创建配置文件模板（包含主机认证配置）
- [ ] 1.5 确保所有文件使用 `node:` 前缀导入内置模块

## 2. 模块入口（index.js）- 先开发入口
- [ ] 2.1 实现模块初始化
  - [ ] 2.1.1 实现init方法框架
  - [ ] 2.1.2 准备子模块实例占位
  - [ ] 2.1.3 处理配置参数
- [ ] 2.2 实现工具调用路由框架
  - [ ] 2.2.1 实现executeToolCall方法框架
  - [ ] 2.2.2 实现参数验证
  - [ ] 2.2.3 实现统一错误捕获和日志记录
- [ ] 2.3 实现模块生命周期管理
  - [ ] 2.3.1 实现shutdown方法框架
- [ ] 2.4 实现工具定义导出
  - [ ] 2.4.1 实现getToolDefinitions方法框架
- [ ] 2.5 测试模块加载
  - [ ] 2.5.1 集成到agent society系统
  - [ ] 2.5.2 测试模块初始化
  - [ ] 2.5.3 测试getToolDefinitions调用

## 3. 工具定义（tools.js）- 定义接口
- [ ] 3.1 定义连接管理工具
  - [ ] 3.1.1 定义ssh_list_hosts工具
  - [ ] 3.1.2 定义ssh_connect工具
  - [ ] 3.1.3 定义ssh_disconnect工具
  - [ ] 3.1.4 定义ssh_list_connections工具
- [ ] 3.2 定义交互式会话工具
  - [ ] 3.2.1 定义ssh_shell_create工具
  - [ ] 3.2.2 定义ssh_shell_send工具（异步发送）
  - [ ] 3.2.3 定义ssh_shell_read工具（指定偏移读取）
  - [ ] 3.2.4 定义ssh_shell_close工具
- [ ] 3.3 定义文件传输工具
  - [ ] 3.3.1 定义ssh_upload工具（异步，返回taskId和fileSize）
  - [ ] 3.3.2 定义ssh_download工具（异步，返回taskId和fileSize）
  - [ ] 3.3.3 定义ssh_transfer_status工具（查询传输进度）
  - [ ] 3.3.4 定义ssh_transfer_cancel工具（取消传输）
- [ ] 3.4 测试工具定义
  - [ ] 3.4.1 验证工具定义格式正确
  - [ ] 3.4.2 测试大模型能否看到工具列表

## 4. 连接管理器（ConnectionManager）- 第一个具体模块
- [ ] 4.1 实现连接管理器基础结构
  - [ ] 4.1.1 创建ConnectionManager类
  - [ ] 4.1.2 实现连接池数据结构
  - [ ] 4.1.3 实现连接ID生成逻辑
- [ ] 4.2 实现listHosts功能
  - [ ] 4.2.1 实现配置文件读取逻辑
  - [ ] 4.2.2 实现listHosts方法（列出主机名称和描述）
  - [ ] 4.2.3 在index.js中路由ssh_list_hosts到此方法
  - [ ] 4.2.4 测试调用ssh_list_hosts工具
- [ ] 4.3 实现连接建立功能
  - [ ] 4.3.1 实现通过主机名称查找配置
  - [ ] 4.3.2 实现密码认证连接
  - [ ] 4.3.3 实现密钥认证连接
  - [ ] 4.3.4 实现连接超时控制
  - [ ] 4.3.5 实现连接错误处理
  - [ ] 4.3.6 在index.js中路由ssh_connect到此方法
  - [ ] 4.3.7 测试调用ssh_connect工具
- [ ] 4.4 实现连接管理功能
  - [ ] 4.4.1 实现获取连接实例方法
  - [ ] 4.4.2 实现列出所有连接方法
  - [ ] 4.4.3 在index.js中路由ssh_list_connections
  - [ ] 4.4.4 测试调用ssh_list_connections工具
- [ ] 4.5 实现断开连接功能
  - [ ] 4.5.1 实现断开单个连接方法
  - [ ] 4.5.2 实现关闭所有连接方法
  - [ ] 4.5.3 在index.js中路由ssh_disconnect
  - [ ] 4.5.4 测试调用ssh_disconnect工具
- [ ] 4.6 实现连接状态监控
  - [ ] 4.6.1 实现连接状态更新
  - [ ] 4.6.2 实现连接保活机制
  - [ ] 4.6.3 实现空闲超时清理
- [ ] 4.7 编写ConnectionManager单元测试

## 5. Shell会话管理器（ShellManager）- 第二个具体模块
- [ ] 5.1 实现Shell管理器基础结构
  - [ ] 5.1.1 创建ShellManager类
  - [ ] 5.1.2 实现会话池数据结构
  - [ ] 5.1.3 实现会话ID生成逻辑
  - [ ] 5.1.4 注入ConnectionManager依赖
  - [ ] 5.1.5 实现输出文件路径生成
- [ ] 5.2 实现Shell会话创建
  - [ ] 5.2.1 实现createShell方法
  - [ ] 5.2.2 从runtime.config获取dataDir，生成输出文件路径
  - [ ] 5.2.3 创建本地输出文件
  - [ ] 5.2.4 实现shell流初始化
  - [ ] 5.2.5 启动后台输出监听并追加到文件
  - [ ] 5.2.6 在index.js中路由ssh_shell_create
  - [ ] 5.2.7 测试调用ssh_shell_create工具
- [ ] 5.3 实现异步命令发送
  - [ ] 5.3.1 实现sendCommand方法
  - [ ] 5.3.2 写入命令到shell流，立即返回
  - [ ] 5.3.3 在index.js中路由ssh_shell_send
  - [ ] 5.3.4 测试调用ssh_shell_send工具
- [ ] 5.4 实现输出窗口读取
  - [ ] 5.4.1 实现readOutput方法
  - [ ] 5.4.2 使用fs.open() + fs.read()读取指定偏移
  - [ ] 5.4.3 在index.js中路由ssh_shell_read
  - [ ] 5.4.4 测试调用ssh_shell_read工具
- [ ] 5.5 实现Shell会话关闭
  - [ ] 5.5.1 实现closeShell方法
  - [ ] 5.5.2 在index.js中路由ssh_shell_close
  - [ ] 5.5.3 测试调用ssh_shell_close工具
- [ ] 5.6 实现文件清理
  - [ ] 5.6.1 模块关闭时清理所有输出文件
- [ ] 5.7 编写ShellManager单元测试

## 6. 文件传输（FileTransfer）- 第三个具体模块
  - [ ] 3.5.3 关闭写入流
  - [ ] 3.5.4 保留输出文件
  - [ ] 3.5.5 实现资源清理
  - [ ] 3.5.6 实现会话状态错误处理
    - [ ] 3.5.6.1 实现会话不存在错误（shell_not_found）
    - [ ] 3.5.6.2 实现会话已关闭错误（shell_closed）
- [ ] 3.6 实现文件清理
  - [ ] 3.6.1 模块关闭时清理所有输出文件
- [ ] 3.7 编写ShellManager单元测试

## 6. 文件传输（FileTransfer）- 第三个具体模块
- [ ] 6.1 实现文件传输基础结构
  - [ ] 6.1.1 创建FileTransfer类
  - [ ] 6.1.2 注入ConnectionManager依赖
  - [ ] 6.1.3 实现SFTP会话管理
  - [ ] 6.1.4 实现任务数据结构和任务池管理
  - [ ] 6.1.5 实现连接断开时自动失败相关任务的方法
- [ ] 6.2 实现异步文件上传功能
  - [ ] 6.2.1 实现upload方法（立即返回taskId和fileSize）
  - [ ] 6.2.2 后台执行上传
  - [ ] 6.2.3 在index.js中路由ssh_upload
  - [ ] 6.2.4 测试调用ssh_upload工具
- [ ] 6.3 实现异步文件下载功能
  - [ ] 6.3.1 实现download方法（立即返回taskId和fileSize）
  - [ ] 6.3.2 后台执行下载
  - [ ] 6.3.3 在index.js中路由ssh_download
  - [ ] 6.3.4 测试调用ssh_download工具
- [ ] 6.4 实现查询传输状态功能
  - [ ] 6.4.1 实现getTransferStatus方法
  - [ ] 6.4.2 在index.js中路由ssh_transfer_status
  - [ ] 6.4.3 测试调用ssh_transfer_status工具
- [ ] 6.5 实现取消传输功能
  - [ ] 6.5.1 实现cancelTransfer方法
  - [ ] 6.5.2 在index.js中路由ssh_transfer_cancel
  - [ ] 6.5.3 测试调用ssh_transfer_cancel工具
- [ ] 6.6 实现定期清理已完成任务的机制
- [ ] 6.7 编写FileTransfer单元测试

## 7. 集成测试
- [ ] 4.6 编写FileTransfer单元测试

## 5. 工具定义（tools.js）
- [ ] 5.1 定义连接管理工具
  - [ ] 5.1.1 定义ssh_list_hosts工具
  - [ ] 5.1.2 定义ssh_connect工具
  - [ ] 5.1.3 定义ssh_disconnect工具
  - [ ] 5.1.4 定义ssh_list_connections工具
- [ ] 5.2 定义交互式会话工具
  - [ ] 5.2.1 定义ssh_shell_create工具
  - [ ] 5.2.2 定义ssh_shell_send工具（异步发送）
  - [ ] 5.2.3 定义ssh_shell_read工具（指定偏移读取）
  - [ ] 5.2.4 定义ssh_shell_close工具
- [ ] 5.3 定义文件传输工具
  - [ ] 5.3.1 定义ssh_upload工具（异步，返回taskId和fileSize）
  - [ ] 5.3.2 定义ssh_download工具（异步，返回taskId和fileSize）
  - [ ] 5.3.3 定义ssh_transfer_status工具（查询传输进度）
  - [ ] 5.3.4 定义ssh_transfer_cancel工具（取消传输）

## 6. 模块入口（index.js）
## 7. 集成测试
- [ ] 7.1 准备测试环境
  - [ ] 7.1.1 搭建SSH测试服务器
  - [ ] 7.1.2 创建测试用户和密钥
  - [ ] 7.1.3 准备测试文件和目录
- [ ] 7.2 编写集成测试
  - [ ] 7.2.1 测试完整工作流（连接→shell→传输→断开）
  - [ ] 7.2.2 测试异步文件传输和进度查询
  - [ ] 7.2.3 测试协程环境下的读写交替
  - [ ] 7.2.4 测试多连接并发
  - [ ] 7.2.5 测试错误处理
  - [ ] 7.2.6 测试资源清理
- [ ] 7.3 执行测试并修复问题

## 8. 文档
- [ ] 8.1 编写模块说明文档（ssh.md）
- [ ] 8.2 编写使用指南（README.md）
- [ ] 8.3 编写API文档

## 9. 代码审查和优化
- [ ] 9.1 代码质量检查
- [ ] 9.2 性能优化
- [ ] 9.3 安全审查

## 10. 发布
- [ ] 10.1 编写变更日志（CHANGELOG.md）
- [ ] 10.2 更新项目文档

## 任务优先级说明
- 高优先级：1, 2, 3, 4（入口和连接管理）
- 中优先级：5, 6（Shell和文件传输）
- 低优先级：7, 8, 9, 10（测试和文档）

## 开发流程强调
每完成一个小功能就：
1. 在index.js中添加路由
2. 立即测试工具调用
3. 确认可用后再开发下一个
4. 小步快跑，不要一次开发太多
  - [ ] 9.2.2 优化内存使用
  - [ ] 9.2.3 优化错误处理性能
- [ ] 9.3 安全审查
  - [ ] 9.3.1 检查敏感信息处理
  - [ ] 9.3.2 检查错误信息泄露
  - [ ] 9.3.3 检查资源泄漏风险

## 10. 集成和发布
- [ ] 10.1 集成到agent society系统
  - [ ] 10.1.1 更新模块加载配置
  - [ ] 10.1.2 测试模块加载
  - [ ] 10.1.3 测试工具调用
- [ ] 10.2 编写变更日志（CHANGELOG.md）
- [ ] 10.3 更新项目文档
  - [ ] 10.3.1 更新modules/modules.md
  - [ ] 10.3.2 更新项目README.md

## 任务优先级说明
- 高优先级：1, 2, 3, 4（入口和连接管理）
- 中优先级：5, 6（Shell和文件传输）
- 低优先级：7, 8, 9, 10（测试和文档）

## 开发流程强调
每完成一个小功能就：
1. 在index.js中添加路由
2. 立即测试工具调用
3. 确认可用后再开发下一个
4. 小步快跑，不要一次开发太多

## 预估工作量
- 阶段一（入口和工具定义）：0.5天
- 阶段二（连接管理）：1天
- 阶段三（Shell会话）：1天
- 阶段四（文件传输）：1天
- 阶段五（测试和文档）：1天
- 总计：4.5天

