# 实现计划: 聊天对话界面工件显示功能

## 概述

扩展聊天面板的工件显示功能，从只显示图片工件改为显示所有类型工件并按类型分组。采用功能优先的开发策略，先实现基本功能，再逐步完善，确保每一步都有可测试的功能效果。

## 任务（功能优先顺序）

- [ ] 1. 显示所有工件类型（基础功能 - 立即可见）
  - [x] 1.1 修改 `renderToolCallGroupArtifacts` 方法
    - [x] 1.1.1 扩展工件收集逻辑，从所有payload字段收集工件
    - [x] 1.1.2 实现简单的全类型工件显示（暂不分组）
    - [x] 1.1.3 保持图片缩略图显示不变
    - [x] 1.1.4 非图片工件显示为简单链接列表
  - [x] 1.1.5 修复工件收集逻辑错误
    - [x] 1.1.5.1 修复 `_collectArtifactsFromField` 参数错误
    - [x] 1.1.5.2 正确处理 `artifactRef` 格式的工件数据
    - [x] 1.1.5.3 移除对 `payload` 和 `payload.result` 的重复兼容
  - [x] 1.1.6 统一工件数据格式
    - [x] 1.1.6.1 调研现有工具调用的工件输出格式
    - [x] 1.1.6.2 确定统一的工件数据结构
    - [x] 1.1.6.3 更新工件收集逻辑以匹配统一格式
  - [ ] 1.2 添加基础样式支持
    - [x] 1.2.1 为非图片工件添加基础链接样式
    - [x] 1.2.2 确保与现有图片样式不冲突
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ] 2. 检查点 - 确保所有工件都能显示
  - 验证所有类型工件都能在界面中显示，询问用户反馈

- [ ] 3. 实现按类型分组功能（组织功能）
  - [x] 3.1 实现工件类型识别逻辑
    - [x] 3.1.1 复用 ArtifactManager._isImageType() 判断图片类型
    - [x] 3.1.2 实现其他类型识别（JSON、文本、HTML、代码等）
    - [x] 3.1.3 建立类型到分组名称的映射
  - [x] 3.2 实现分组显示逻辑
    - [x] 3.2.1 将工件按类型分组
    - [x] 3.2.2 为每个分组添加标题显示
    - [x] 3.2.3 复用 ArtifactManager._getFileIconByType() 获取分组图标
  - [x] 3.3 更新HTML结构和样式
    - [x] 3.3.1 设计分组标题样式（图标+标题文字）
    - [x] 3.3.2 调整工件链接在分组内的显示
  - _需求: 2.1, 2.2, 2.3, 2.4_

- [ ] 4. 检查点 - 确保分组功能正常
  - 验证工件按类型正确分组显示，询问用户反馈

- [ ] 5. 实现点击交互功能（交互功能）
  - [ ] 5.1 保持图片点击交互不变
    - [ ] 5.1.1 确保图片工件仍能正常打开ImageViewer
    - [ ] 5.1.2 验证图片导航功能正常
  - [x] 5.2 实现非图片工件点击交互
    - [x] 5.2.1 为非图片工件添加点击事件处理
    - [x] 5.2.2 根据工件类型打开相应查看器
    - [x] 5.2.3 处理点击失败的错误情况
  - [ ] 5.3 优化事件绑定机制
    - [ ] 5.3.1 使用事件委托处理动态生成的工件链接
    - [ ] 5.3.2 从事件目标获取工件信息
  - _需求: 3.1, 3.2, 3.3, 3.4_

- [ ] 6. 检查点 - 确保交互功能正常
  - 验证所有工件点击交互正常工作，询问用户反馈

- [ ] 7. 美化和优化（样式优化）
  - [ ] 7.1 优化视觉效果
    - [ ] 7.1.1 完善分组标题样式设计
    - [ ] 7.1.2 优化工件链接的视觉效果
    - [ ] 7.1.3 添加悬停和焦点状态样式
    - [ ] 7.1.4 确保响应式布局适配
  - [ ] 7.2 优化用户体验
    - [ ] 7.2.1 添加工件加载状态提示
    - [ ] 7.2.2 优化长文件名的截断显示
    - [ ] 7.2.3 改善错误状态的用户提示
  - [ ] 7.3 性能优化
    - [ ] 7.3.1 优化大量工件时的渲染性能
    - [ ] 7.3.2 减少不必要的DOM操作
  - _需求: 4.1, 4.2, 4.3, 4.4, 4.5, 5.1, 5.2_

- [ ] 8. 代码重构和架构优化（可选 - 代码质量）
  - [ ] 8.1* 重构为模块化架构
    - [ ] 8.1.1* 提取工件收集器模块
    - [ ] 8.1.2* 提取工件分组器模块
    - [ ] 8.1.3* 提取工件渲染器模块
    - [ ] 8.1.4* 提取交互处理器模块
  - [ ] 8.2* 实现注册机制
    - [ ] 8.2.1* 建立类型识别器注册表
    - [ ] 8.2.2* 建立类型渲染器注册表
    - [ ] 8.2.3* 建立类型处理器注册表
  - _需求: 6.1, 6.2, 6.3, 6.4_

- [ ] 9. 测试和验证（可选 - 质量保证）
  - [ ] 9.1* 创建单元测试
    - [ ] 9.1.1* 测试工件收集逻辑
    - [ ] 9.1.2* 测试类型分组逻辑
    - [ ] 9.1.3* 测试渲染输出正确性
  - [ ] 9.2* 创建属性测试
    - [ ] 9.2.1* 属性1: 全类型工件收集
    - [ ] 9.2.2* 属性2: 图片工件缩略图显示
    - [ ] 9.2.3* 属性3: 非图片工件分组显示
    - [ ] 9.2.4* 属性4: 类型分组一致性
    - [ ] 9.2.5* 属性5: 工件管理器一致性
    - [ ] 9.2.6* 属性6: 交互行为保持
    - [ ] 9.2.7* 属性7: 错误状态处理
    - [ ] 9.2.8* 属性8: 文本截断处理

## 开发策略

1. **功能优先**: 先实现基本功能，确保用户能看到所有工件
2. **增量开发**: 每个功能完成后都有可测试的效果
3. **早期反馈**: 在关键节点设置检查点，确保方向正确
4. **渐进增强**: 从简单实现开始，逐步完善功能和体验

## 检查点说明

- **检查点2**: 确认所有工件类型都能显示，验证基础功能
- **检查点4**: 确认分组功能正确，验证组织逻辑
- **检查点6**: 确认交互功能正常，验证用户体验

## 注意事项

- 标记 `*` 的任务为可选优化任务，可根据时间安排决定是否执行
- 每个任务引用具体需求以确保可追溯性
- 检查点确保增量验证和用户反馈
- 优先保证功能可用性，再考虑代码架构和性能优化
- 每一步完成后都应该有可见的、可测试的功能改进