# 需求文档

## 简介

本功能旨在为 root 智能体创建的直接子级智能体提供默认的工作空间能力。当 root 创建一个新的子智能体时，系统会为该智能体及其所有后代分配一个独立的工作空间。工作空间采用懒加载策略，只有在实际写入文件时才会真正创建文件夹。

工作空间用于编程、跨文件写作等工作场景中的文件操作和最终制品输出。智能体无法感知工作空间的绝对路径，只能在工作空间内进行相对路径的文件操作。

由于 root 创建的每个直接子智能体都有自己的 task，因此工作空间的隔离实际上是基于 task 的隔离。虽然工作空间以智能体 ID 命名，但在最终效果上等同于按 taskId 隔离。

## 术语表

- **工作空间（Workspace）**: 智能体的独立文件系统目录，用于存储工作过程中产生的文件和最终制品
- **工作空间管理器（WorkspaceManager）**: 负责工作空间生命周期管理的平台组件
- **运行时（Runtime）**: 运行时系统，负责智能体调度和平台能力协调
- **智能体（Agent）**: 智能体实例，在工作空间上下文中执行具体工作
- **root 智能体**: 系统根智能体，负责接收用户需求并创建子智能体
- **直接子级智能体**: 由 root 智能体直接创建的智能体（parentAgentId 为 root）
- **任务（Task）**: root 创建的每个直接子智能体都代表一个独立的任务

## 需求列表

### 需求 1: root 创建子智能体时分配工作空间

**用户故事:** 作为 root 智能体，我希望在创建直接子级智能体时自动为其分配一个工作空间，这样子智能体及其后代可以在隔离的环境中进行文件操作。

#### 验收标准

1. 当 root 智能体创建直接子级智能体时，运行时应为该智能体分配一个工作空间
2. 工作空间路径应基于新创建的智能体 ID 命名，格式为 `{dataDir}/workspaces/{agentId}`
3. 工作空间分配应仅记录路径信息，不应立即创建实际的文件夹（懒加载）
4. 该智能体的所有后代智能体应自然继承同一个工作空间

### 需求 2: 工作空间懒加载创建

**用户故事:** 作为系统管理员，我希望工作空间文件夹只在实际需要时才创建，这样可以避免创建大量空文件夹。

#### 验收标准

1. 当工作空间被分配时，工作空间管理器不应立即创建文件夹
2. 当智能体首次向工作空间写入文件时，工作空间管理器应自动创建工作空间文件夹
3. 当智能体读取或列出工作空间内容时，如果文件夹不存在，应返回空结果而不是错误
4. 当工作空间始终没有文件写入时，不应存在对应的文件夹

### 需求 3: 工作空间文件操作工具

**用户故事:** 作为智能体，我希望使用工具在工作空间中读写文件，这样我可以完成编程和写作任务。

#### 验收标准

1. 运行时应提供 write_file 工具，用于在工作空间中写入文件内容
2. 运行时应提供 read_file 工具，用于从工作空间中读取文件内容
3. 运行时应提供 list_files 工具，用于列出工作空间中的文件和目录
4. 所有文件操作工具只接受相对路径参数，智能体无法感知工作空间的绝对路径
5. 当 write_file 在不存在的子目录中创建文件时，工作空间管理器应自动创建父目录

### 需求 4: 工作空间路径安全

**用户故事:** 作为系统管理员，我希望智能体只能在其工作空间内操作文件，这样可以防止越权访问。

#### 验收标准

1. 当文件操作的目标路径尝试逃逸工作空间时，工作空间管理器应拒绝操作并返回 path_traversal_blocked 错误
2. 工作空间管理器应拒绝包含 .. 的路径
3. 工作空间管理器应拒绝绝对路径
4. 智能体无法获取或感知工作空间的绝对路径

### 需求 5: 任务级工作空间隔离

**用户故事:** 作为系统管理员，我希望不同任务的工作空间相互隔离，这样它们之间不会相互干扰。

#### 验收标准

1. 对于所有由 root 直接创建的不同智能体（即不同任务），它们的工作空间路径应该不同
2. 同一任务内的所有智能体（包括后代智能体）应共享同一个工作空间
3. 一个任务内的智能体无法访问另一个任务的工作空间

### 需求 6: 工作空间信息查询

**用户故事:** 作为智能体，我希望查询工作空间的状态信息，这样我可以了解当前工作空间的文件数量和大小。

#### 验收标准

1. 运行时应提供 get_workspace_info 工具，用于返回工作空间统计信息
2. 当工作空间文件夹存在时，工作空间管理器应返回文件数量、目录数量、总大小和最后修改时间戳
3. 当工作空间文件夹不存在（未写入过文件）时，应返回空的统计信息（文件数量为0等）

### 需求 7: 后代智能体工作空间继承

**用户故事:** 作为架构师智能体，我希望我创建的子智能体能够访问相同的工作空间，这样团队成员可以在同一个项目目录中协作。

#### 验收标准

1. 当智能体创建子智能体时，子智能体应自然继承父智能体的工作空间
2. 工作空间继承应沿着智能体层级向下传递，所有后代共享同一个工作空间
3. 只有 root 创建的直接子智能体才会获得新的工作空间，其他情况都是继承
