# 实现计划：JSON工件查看器增强

## 概述

本实现计划分为以下阶段：
1. JSON内容解析器实现
2. 工件管理器视图切换功能
3. 文本视图实现
4. 集成和测试

## 任务列表

- [x] 1. 创建JSON内容解析器
  - 创建 `web/js/utils/json-parser.js`
  - 实现 `parseJsonContent` 函数，处理双重编码
  - 支持递归解析多重编码的JSON字符串
  - 返回解析结果和错误信息
  - _需求: 1.1, 1.2, 1.3, 1.4_

- [x] 1.1 为JSON内容解析器编写属性测试
  - **属性1：JSON内容解析正确性**
  - **属性2：双重编码处理**
  - **验证：需求 1.1, 1.2, 1.3**

- [x] 2. 增强工件管理器支持JSON视图切换
  - 在 `artifact-manager.js` 中添加 `jsonDisplayMode` 状态
  - 添加 `setJsonDisplayMode` 方法
  - 修改 `_displayArtifact` 方法，对JSON工件使用解析器
  - 添加文本/JSON切换按钮到UI
  - _需求: 6.4, 6.5, 6.6, 6.7_

- [x] 2.1 为视图切换功能编写属性测试
  - **属性13：视图模式切换正确性**
  - **验证：需求 6.5, 6.6**

- [x] 3. 实现JSON文本视图
  - 实现 `_renderJsonTextView` 方法
  - 支持5000字符截断
  - 显示截断提示信息
  - 格式化JSON文本显示（缩进）
  - _需求: 6.1, 6.2, 6.3_

- [x] 3.1 为文本视图截断编写属性测试
  - **属性12：文本视图截断正确性**
  - **验证：需求 6.2, 6.3**

- [x] 4. 集成JSON解析器到工件显示流程
  - 在加载JSON工件时调用解析器
  - 处理解析错误情况
  - 确保双重编码的JSON能正确显示
  - _需求: 1.1, 1.2, 1.3, 1.4_

- [x] 5. 检查点 - 确保基本功能正常
  - 验证JSON工件能正确解析和显示
  - 验证视图切换功能正常
  - 如有问题，请咨询用户

- [x] 6. 为现有JSON查看器功能编写属性测试
  - [x] 6.1 树状视图渲染测试
    - **属性3：树状视图键值完整性**
    - **属性4：数组索引完整性**
    - **属性5：元素数量显示正确性**
    - **验证：需求 2.1, 2.2, 2.4**
  - [x] 6.2 展开/收缩功能测试
    - **属性6：展开/收缩幂等性**
    - **验证：需求 3.1, 3.2, 3.4**
  - [x] 6.3 复制功能测试
    - **属性7：复制字段名正确性**
    - **属性8：复制字段值正确性**
    - **属性9：复制对象往返正确性**
    - **验证：需求 4.2, 4.3, 4.4**
  - [x] 6.4 字符串截断测试
    - **属性10：字符串截断一致性**
    - **属性11：截断字符串复制完整性**
    - **验证：需求 5.1, 5.2, 5.3**

- [x] 7. 修复工件存储双重编码问题
  - 检查 `artifact_store.js` 中的 `putArtifact` 方法
  - 确保JSON内容不会被双重序列化
  - 添加内容类型检测逻辑
  - _需求: 7.1, 7.2, 7.3_

- [x] 7.1 为工件存储编写属性测试
  - **属性14：工件存储往返正确性**
  - **验证：需求 7.1, 7.2, 7.3**

- [x] 8. 样式调整
  - 确保文本/JSON切换按钮样式与现有文本/Markdown按钮一致
  - 添加截断提示样式
  - _需求: 6.7_

- [x] 9. 最终检查点 - 确保所有测试通过
  - 运行所有属性测试
  - 运行所有单元测试
  - 验证完整的用户工作流
  - 如有问题，请咨询用户

## 注意事项

- 所有任务都是必需的，包括完整的属性测试
- 每个任务都引用了特定的需求，以便追踪
- 属性测试使用 fast-check 库
- 所有代码应遵循现有的代码风格和约定

