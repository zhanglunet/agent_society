# 设计文档：JSON工件查看器增强

## 概述

本设计增强现有的JSON工件查看器，解决JSON内容双重编码问题，并添加文本/JSON视图切换功能。用户可以选择以纯文本形式（默认）或树状JSON结构查看JSON工件内容。

## 架构

### 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    工件管理器 (ArtifactManager)               │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────┐   │
│  │              工件查看器容器                            │   │
│  │  ┌────────────────────────────────────────────────┐ │   │
│  │  │ 视图切换按钮: [文本] [JSON]                      │ │   │
│  │  └────────────────────────────────────────────────┘ │   │
│  │  ┌────────────────────────────────────────────────┐ │   │
│  │  │ 文本视图 (默认)                                 │ │   │
│  │  │ - 纯文本显示                                    │ │   │
│  │  │ - 5000字符限制                                  │ │   │
│  │  └────────────────────────────────────────────────┘ │   │
│  │  ┌────────────────────────────────────────────────┐ │   │
│  │  │ JSON树状视图                                    │ │   │
│  │  │ - 展开/收缩节点                                 │ │   │
│  │  │ - 右键复制菜单                                  │ │   │
│  │  │ - 字符串截断                                    │ │   │
│  │  └────────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 数据流

```
工件存储 (artifact_store.js)
    ↓ 读取工件内容
JSON内容解析器 (parseJsonContent)
    ↓ 检测并解析双重编码
工件管理器 (_displayArtifact)
    ↓ 根据视图模式选择渲染器
    ├─→ 文本视图 (默认): 显示格式化JSON文本
    └─→ JSON树状视图: 使用JSONViewer组件
```

## 组件和接口

### 1. JSON内容解析器 (parseJsonContent)

**职责：**
- 检测内容是否为双重编码的JSON字符串
- 自动解析并返回正确的JSON对象
- 处理解析错误

**函数签名：**
```javascript
/**
 * 解析JSON内容，处理双重编码情况
 * @param {any} content - 原始内容（可能是对象或字符串）
 * @returns {{data: any, isValid: boolean, error?: string}}
 */
function parseJsonContent(content) {
  // 如果已经是对象，直接返回
  if (typeof content === "object" && content !== null) {
    return { data: content, isValid: true };
  }
  
  // 如果是字符串，尝试解析
  if (typeof content === "string") {
    try {
      const parsed = JSON.parse(content);
      // 递归检查是否还需要再次解析（处理多重编码）
      if (typeof parsed === "string") {
        return parseJsonContent(parsed);
      }
      return { data: parsed, isValid: true };
    } catch (e) {
      return { data: content, isValid: false, error: e.message };
    }
  }
  
  // 其他类型直接返回
  return { data: content, isValid: true };
}
```

### 2. 工件管理器增强 (ArtifactManager)

**新增属性：**
```javascript
this.jsonDisplayMode = "text"; // "text" 或 "json"
this.currentJsonContent = null; // 当前JSON内容（解析后）
this.currentJsonRaw = null; // 当前JSON原始文本
```

**新增方法：**
```javascript
/**
 * 设置JSON显示模式
 * @param {string} mode - "text" 或 "json"
 */
setJsonDisplayMode(mode) {
  this.jsonDisplayMode = mode;
  // 更新按钮状态
  // 重新渲染内容
}

/**
 * 渲染JSON文本视图
 * @param {string} content - JSON文本内容
 */
_renderJsonTextView(content) {
  const maxLength = 5000;
  let displayContent = content;
  let isTruncated = false;
  
  if (content.length > maxLength) {
    displayContent = content.substring(0, maxLength);
    isTruncated = true;
  }
  
  // 渲染文本内容
  // 如果截断，显示提示
}

/**
 * 渲染JSON树状视图
 * @param {object} data - 解析后的JSON对象
 */
_renderJsonTreeView(data) {
  const viewer = new JSONViewer({ container: this.viewerPanel });
  viewer.render(data);
  this.currentViewer = viewer;
}
```

### 3. JSON查看器增强 (JSONViewer)

**现有功能（已实现）：**
- 树状视图渲染
- 展开/收缩节点
- 字符串截断（100字符）
- 右键复制菜单

**无需修改**，现有实现已满足需求。

## 数据模型

### JSON工件内容结构

```javascript
// 原始存储格式（可能双重编码）
{
  id: "uuid",
  content: "{\"key\": \"value\"}", // 字符串形式
  type: "application/json",
  extension: ".json"
}

// 解析后格式
{
  id: "uuid",
  content: { key: "value" }, // 对象形式
  type: "application/json",
  extension: ".json"
}
```

## 用户界面设计

### 视图切换按钮

```
┌─────────────────────────────────────────┐
│ [文本] [JSON]                           │  ← 切换按钮（样式同文本/Markdown）
├─────────────────────────────────────────┤
│                                         │
│  {                                      │  ← 文本视图（默认）
│    "reminders": [                       │
│      {                                  │
│        "id": 1,                         │
│        "time": "3分钟",                 │
│        "content": "吃饭",               │
│        ...                              │
│      }                                  │
│    ]                                    │
│  }                                      │
│                                         │
│  [内容已截断，共 12345 字符]             │  ← 截断提示（如果超过5000字符）
│                                         │
└─────────────────────────────────────────┘
```

### JSON树状视图

```
┌─────────────────────────────────────────┐
│ [文本] [JSON]                           │
├─────────────────────────────────────────┤
│ ▼ root Object{1}                        │
│   ▼ reminders Array[3]                  │
│     ▼ [0] Object{4}                     │
│       • id: 1                           │
│       • time: "3分钟"                   │
│       • content: "吃饭"                 │
│       • status: "已完成"                │
│     ▶ [1] Object{4}                     │
│     ▶ [2] Object{4}                     │
└─────────────────────────────────────────┘
```

## 正确性属性

*属性是一个特征或行为，应该在系统的所有有效执行中保持真实——本质上是关于系统应该做什么的正式陈述。属性充当人类可读规范和机器可验证的正确性保证之间的桥梁。*

### 属性1：JSON内容解析正确性

*对于任何* JSON对象，将其序列化为字符串后传入解析器，解析结果应该与原始对象深度相等。

**验证：需求 1.1, 1.2, 1.3**

### 属性2：双重编码处理

*对于任何* JSON对象，将其双重序列化（JSON.stringify两次）后传入解析器，解析结果应该与原始对象深度相等。

**验证：需求 1.2**

### 属性3：树状视图键值完整性

*对于任何* JSON对象，渲染为树状视图后，所有顶层键名都应该出现在渲染输出中。

**验证：需求 2.1**

### 属性4：数组索引完整性

*对于任何* JSON数组，渲染为树状视图后，所有数组索引（[0], [1], ...）都应该出现在渲染输出中。

**验证：需求 2.2**

### 属性5：元素数量显示正确性

*对于任何* JSON对象或数组，显示的元素数量应该与实际的键数量或数组长度相等。

**验证：需求 2.4**

### 属性6：展开/收缩幂等性

*对于任何* 可展开的JSON节点，展开后收缩再展开，应该显示相同的子节点内容。

**验证：需求 3.1, 3.2, 3.4**

### 属性7：复制字段名正确性

*对于任何* JSON字段，复制字段名操作应该将准确的字段名复制到剪贴板。

**验证：需求 4.2**

### 属性8：复制字段值正确性

*对于任何* JSON字段值，复制字段值操作应该将准确的值复制到剪贴板（对象/数组应为格式化JSON）。

**验证：需求 4.3**

### 属性9：复制对象往返正确性

*对于任何* JSON对象，复制对象操作复制的内容应该是有效的JSON，解析后应该与原始对象深度相等。

**验证：需求 4.4**

### 属性10：字符串截断一致性

*对于任何* 长度超过100字符的字符串，显示的文本应该以省略号结尾，且title属性应该包含完整字符串。

**验证：需求 5.1, 5.2**

### 属性11：截断字符串复制完整性

*对于任何* 被截断显示的字符串，复制操作应该复制完整的原始字符串。

**验证：需求 5.3**

### 属性12：文本视图截断正确性

*对于任何* 长度超过5000字符的JSON文本，文本视图应该只显示前5000字符，并显示截断提示。

**验证：需求 6.2, 6.3**

### 属性13：视图模式切换正确性

*对于任何* JSON工件，切换到JSON视图应该显示树状结构，切换到文本视图应该显示纯文本。

**验证：需求 6.5, 6.6**

### 属性14：工件存储往返正确性

*对于任何* JSON对象，存储后读取应该返回与原始对象深度相等的对象（不应该是字符串）。

**验证：需求 7.1, 7.2, 7.3**

## 错误处理

### 错误场景

1. **JSON解析失败**：显示原始文本内容，并在顶部显示解析错误提示
2. **内容为空**：显示"内容为空"提示
3. **复制失败**：显示"复制失败"错误提示

### 错误消息

```javascript
{
  JSON_PARSE_ERROR: "JSON解析失败: {error}",
  EMPTY_CONTENT: "内容为空",
  COPY_FAILED: "复制失败",
  CONTENT_TRUNCATED: "内容已截断，共 {total} 字符，显示前 5000 字符"
}
```

## 测试策略

### 单元测试

- JSON内容解析器（parseJsonContent）
- 字符串截断函数
- 视图模式切换逻辑

### 属性测试

使用 fast-check 库进行属性测试：

- **属性1-2**：JSON解析正确性（生成随机JSON对象，测试解析结果）
- **属性3-5**：树状视图渲染正确性（生成随机JSON，验证渲染输出）
- **属性6**：展开/收缩幂等性（模拟用户操作，验证状态一致性）
- **属性7-9**：复制功能正确性（生成随机数据，验证剪贴板内容）
- **属性10-11**：字符串截断正确性（生成长字符串，验证截断和复制行为）
- **属性12**：文本视图截断正确性（生成长JSON，验证截断行为）
- **属性13**：视图模式切换正确性（模拟切换，验证视图状态）
- **属性14**：存储往返正确性（存储和读取，验证数据一致性）

### 集成测试

- 完整的JSON工件查看流程
- 视图切换交互
- 复制功能端到端测试

## 技术栈

- **前端框架**：原生JavaScript（与现有代码一致）
- **属性测试**：fast-check（已在项目中使用）
- **样式**：CSS3（复用现有样式）

## 依赖关系

- 现有的 `web/js/components/json-viewer.js`
- 现有的 `web/js/components/artifact-manager.js`
- 后端 `src/platform/artifact_store.js`

