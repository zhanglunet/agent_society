# 实施计划：Agent Society 代码重构

## 概述

本实施计划将设计文档中的重构方案转化为可执行的任务列表。重构分为 5 个阶段，每个阶段完成后系统可正常运行。

## 任务列表

### 阶段 1：测试基础建设

- [-] 1. 建立测试基础设施
  - [x] 1.1 配置测试环境和测试框架
    - 确保测试框架配置正确
    - 配置代码覆盖率工具
    - _需求：11.1, 11.2, 11.3_
  
  - [x] 1.2 为核心模块编写单元测试
    - 为 AgentSociety 编写单元测试
    - 为 Runtime 编写单元测试
    - 为 MessageBus 编写单元测试
    - 为 OrgPrimitives 编写单元测试
    - _需求：11.1, 11.2_
  
  - [x] 1.3 为服务模块编写单元测试
    - 为 ArtifactStore 编写单元测试
    - 为 LlmClient 编写单元测试
    - 为 ConversationManager 编写单元测试
    - 为 WorkspaceManager 编写单元测试
    - _需求：11.1, 11.2_
  
  - [x] 1.4 为 Runtime 子模块编写单元测试
    - 为 AgentManager 编写单元测试
    - 为 MessageProcessor 编写单元测试
    - 为 ToolExecutor 编写单元测试
    - 为 LlmHandler 编写单元测试
    - _需求：11.1, 11.2_
  
  - [x] 1.5 编写集成测试
    - 测试智能体创建和终止流程
    - 测试消息发送和接收流程
    - 测试工件存储和检索流程
    - 测试 LLM 调用和重试流程
    - _需求：11.2, 11.3_
  
  - [x] 1.6 编写端到端测试
    - 测试需求提交到任务完成的完整流程
    - 测试多智能体协作场景
    - _需求：8.5, 11.3_
  
  - [x] 1.7 建立测试基准
    - 运行所有测试并记录结果
    - 记录测试覆盖率
    - 保存测试基准数据
    - _需求：11.4, 11.5_
  
  - [x] 1.8 设置 CI/CD 流程
    - 配置自动化测试运行
    - 配置代码覆盖率报告
    - 配置测试失败通知
    - _需求：11.4_

- [x] 2. 检查点 - 测试基础建设完成
  - 确保所有测试通过
  - 确保测试覆盖率达到 80% 以上
  - 询问用户是否有问题

### 阶段 2：目录结构调整

- [x] 3. 创建新的目录结构
  - [x] 3.1 创建核心模块目录
    - 创建 src/platform/core/ 目录
    - 创建 core.md 说明文档
    - _需求：3.5, 4.1, 4.2_
  
  - [x] 3.2 创建服务模块目录
    - 创建 src/platform/services/ 目录及子目录
    - 创建 services.md 和各子目录的说明文档
    - _需求：3.5, 4.1, 4.2_
  
  - [x] 3.3 创建工具模块目录
    - 创建 src/platform/utils/ 目录及子目录
    - 创建 utils.md 和各子目录的说明文档
    - _需求：3.5, 4.1, 4.2_
  
  - [x] 3.4 创建扩展模块目录
    - 创建 src/platform/extensions/ 目录
    - 创建 extensions.md 说明文档
    - _需求：3.5, 4.1, 4.2_

- [x] 4. 移动核心模块文件
  - [x] 4.1 移动 agent_society.js 到 core/
    - 移动文件
    - 更新导入路径
    - 在原位置创建兼容性导出
    - 运行测试验证
    - _需求：8.1, 9.2_
  
  - [x] 4.2 移动 runtime.js 到 core/
    - 移动文件
    - 更新导入路径
    - 在原位置创建兼容性导出
    - 运行测试验证
    - _需求：8.1, 9.2_
  
  - [x] 4.3 移动 message_bus.js 到 core/
    - 移动文件
    - 更新导入路径
    - 在原位置创建兼容性导出
    - 运行测试验证
    - _需求：8.1, 9.2_
  
  - [x] 4.4 移动 org_primitives.js 到 core/
    - 移动文件
    - 更新导入路径
    - 在原位置创建兼容性导出
    - 运行测试验证
    - _需求：8.1, 9.2_

- [x] 5. 移动服务模块文件
  - [x] 5.1 移动工件服务文件到 services/artifact/
    - 移动 artifact_store.js
    - 移动 binary_detector.js
    - 更新导入路径
    - 创建兼容性导出
    - 运行测试验证
    - _需求：8.1, 9.2_
  
  - [x] 5.2 移动 LLM 服务文件到 services/llm/
    - 移动 llm_client.js
    - 移动 llm_service_registry.js
    - 移动 model_selector.js
    - 移动 concurrency_controller.js
    - 更新导入路径
    - 创建兼容性导出
    - 运行测试验证
    - _需求：8.1, 9.2_
  
  - [x] 5.3 移动会话服务文件到 services/conversation/
    - 移动 conversation_manager.js
    - 更新导入路径
    - 创建兼容性导出
    - 运行测试验证
    - _需求：8.1, 9.2_
  
  - [x] 5.4 移动工作空间服务文件到 services/workspace/
    - 移动 workspace_manager.js
    - 移动 command_executor.js
    - 更新导入路径
    - 创建兼容性导出
    - 运行测试验证
    - _需求：8.1, 9.2_
  
  - [x] 5.5 移动 HTTP 服务文件到 services/http/
    - 移动 http_server.js
    - 移动 http_client.js
    - 更新导入路径
    - 创建兼容性导出
    - 运行测试验证
    - _需求：8.1, 9.2_
  
  - [x] 5.6 移动联系人服务文件到 services/contact/
    - 移动 contact_manager.js
    - 更新导入路径
    - 创建兼容性导出
    - 运行测试验证
    - _需求：8.1, 9.2_

- [ ] 6. 移动工具模块文件
  - [x] 6.1 移动消息工具文件到 utils/message/
    - 移动 message_formatter.js
    - 移动 message_validator.js
    - 移动 task_brief.js
    - 更新导入路径
    - 创建兼容性导出
    - 运行测试验证
    - _需求：8.1, 9.2_
  
  - [x] 6.2 移动内容工具文件到 utils/content/
    - 移动 content_adapter.js
    - 移动 capability_router.js
    - 更新导入路径
    - 创建兼容性导出
    - 运行测试验证
    - _需求：8.1, 9.2_
  
  - [x] 6.3 移动配置工具文件到 utils/config/
    - 重命名 config.js 为 config_loader.js 并移动
    - 移动 config_service.js
    - 更新导入路径
    - 创建兼容性导出
    - 运行测试验证
    - _需求：8.1, 9.2, 9.3_
  
  - [x] 6.4 移动日志工具文件到 utils/logger/
    - 移动 logger.js
    - 更新导入路径
    - 创建兼容性导出
    - 运行测试验证
    - _需求：8.1, 9.2_

- [ ] 7. 移动扩展模块文件
  - [ ] 7.1 移动模块加载器到 extensions/
    - 移动 module_loader.js
    - 移动 tool_group_manager.js
    - 更新导入路径
    - 创建兼容性导出
    - 运行测试验证
    - _需求：8.1, 9.2_

- [ ] 8. 创建统一导出文件
  - [ ] 8.1 创建 src/platform/index.js
    - 导出所有公共接口
    - 提供向后兼容的导出路径
    - _需求：8.1, 9.2_

- [ ] 9. 检查点 - 目录结构调整完成
  - 确保所有测试通过
  - 确保旧导入路径仍然可用
  - 验证目录层级不超过 3 层
  - 验证每个目录都有说明文档
  - 询问用户是否有问题

### 阶段 3：模块合并和拆分

- [ ] 10. 合并配置模块
  - [ ] 10.1 分析 config_loader.js 和 config_service.js 的职责
    - 识别重叠功能
    - 确定合并策略
    - _需求：5.1, 5.4_
  
  - [ ] 10.2 整合配置加载逻辑
    - 保留 config_loader.js 的配置文件加载功能
    - 保留 config_service.js 的配置服务接口
    - 确保两者职责清晰
    - _需求：5.2, 5.3_
  
  - [ ] 10.3 更新配置模块的测试
    - 更新单元测试
    - 确保测试覆盖所有功能
    - _需求：11.2_
  
  - [ ] 10.4 更新配置模块的文档
    - 更新模块注释
    - 更新目录说明文档
    - _需求：12.1, 12.2_

- [ ] 11. 合并内容路由模块
  - [ ] 11.1 合并 artifact_content_router 和 capability_router
    - 创建 services/artifact/content_router.js
    - 合并两个模块的功能
    - 提取通用部分到 utils/content/
    - _需求：5.2, 5.4, 5.5_
  
  - [ ] 11.2 提供兼容性导出
    - 在原位置创建兼容性导出
    - 确保旧代码仍然可用
    - _需求：9.2_
  
  - [ ] 11.3 更新内容路由模块的测试
    - 更新单元测试
    - 确保测试覆盖所有功能
    - _需求：11.2_
  
  - [ ] 11.4 更新内容路由模块的文档
    - 更新模块注释
    - 更新目录说明文档
    - _需求：12.1, 12.2_

- [ ] 12. 整合消息工具模块
  - [ ] 12.1 创建统一的消息工具类
    - 创建 utils/message/index.js
    - 整合 message_formatter、message_validator、task_brief 的功能
    - _需求：5.2, 5.5_
  
  - [ ] 12.2 提供兼容性导出
    - 保留原有的独立文件作为兼容性导出
    - 确保旧代码仍然可用
    - _需求：9.2_
  
  - [ ] 12.3 更新消息工具模块的测试
    - 更新单元测试
    - 确保测试覆盖所有功能
    - _需求：11.2_
  
  - [ ] 12.4 更新消息工具模块的文档
    - 更新模块注释
    - 更新目录说明文档
    - _需求：12.1, 12.2_

- [ ] 13. 拆分 Runtime 类
  - [ ] 13.1 提取状态管理模块
    - 创建 runtime/state_manager.js
    - 将 Runtime 的状态管理逻辑提取到 StateManager
    - 更新 Runtime 使用 StateManager
    - _需求：3.2, 7.1, 7.2_
  
  - [ ] 13.2 提取错误处理模块
    - 创建 runtime/error_handler.js
    - 将 Runtime 的错误处理逻辑提取到 ErrorHandler
    - 更新 Runtime 使用 ErrorHandler
    - _需求：3.2, 7.1, 7.2_
  
  - [ ] 13.3 更新 Runtime 的测试
    - 为 StateManager 编写单元测试
    - 为 ErrorHandler 编写单元测试
    - 更新 Runtime 的单元测试
    - _需求：11.1, 11.2_
  
  - [ ] 13.4 验证 Runtime 代码行数
    - 统计 Runtime 类的代码行数（不含注释）
    - 确保不超过 500 行
    - _需求：3.2_

- [ ] 14. 检查点 - 模块合并和拆分完成
  - 确保所有测试通过
  - 确保所有模块代码行数不超过 500 行
  - 确保提供了兼容性导出
  - 询问用户是否有问题

### 阶段 4：降低耦合

- [ ] 15. 为 Runtime 子模块实现依赖注入
  - [ ] 15.1 定义 AgentRegistry 接口
    - 定义 register、get、has、delete、list 方法
    - 在 Runtime 中实现该接口
    - _需求：6.2, 6.5_
  
  - [ ] 15.2 重构 AgentManager 使用依赖注入
    - 修改 AgentManager 构造函数接受依赖
    - 移除对 Runtime 的直接访问
    - 通过接口访问必要的服务
    - _需求：6.1, 6.2_
  
  - [ ] 15.3 重构 MessageProcessor 使用依赖注入
    - 修改 MessageProcessor 构造函数接受依赖
    - 移除对 Runtime 的直接访问
    - 通过接口访问必要的服务
    - _需求：6.1, 6.2_
  
  - [ ] 15.4 重构 ToolExecutor 使用依赖注入
    - 修改 ToolExecutor 构造函数接受依赖
    - 移除对 Runtime 的直接访问
    - 通过接口访问必要的服务
    - _需求：6.1, 6.2_
  
  - [ ] 15.5 重构 LlmHandler 使用依赖注入
    - 修改 LlmHandler 构造函数接受依赖
    - 移除对 Runtime 的直接访问
    - 通过接口访问必要的服务
    - _需求：6.1, 6.2_
  
  - [ ] 15.6 更新 Runtime 子模块的测试
    - 更新单元测试以使用依赖注入
    - 验证模块可以独立测试
    - _需求：11.2_

- [ ] 16. 使用事件机制解耦模块通信
  - [ ] 16.1 为 LlmClient 实现事件机制
    - 使用 EventEmitter 替代回调
    - 发出 retry、error 等事件
    - _需求：6.1, 6.2_
  
  - [ ] 16.2 更新 LlmClient 的使用者
    - 修改 Runtime 监听 LlmClient 的事件
    - 移除回调函数
    - _需求：6.1_
  
  - [ ] 16.3 更新 LlmClient 的测试
    - 更新单元测试以验证事件机制
    - _需求：11.2_

- [ ] 17. 验证无循环依赖
  - [ ] 17.1 使用静态分析工具检查循环依赖
    - 运行依赖分析工具
    - 生成依赖关系图
    - _需求：3.3, 6.3_
  
  - [ ] 17.2 修复发现的循环依赖
    - 重构代码消除循环依赖
    - 重新运行分析工具验证
    - _需求：3.3, 6.3_

- [ ] 18. 检查点 - 降低耦合完成
  - 确保所有测试通过
  - 确保无循环依赖
  - 确保模块可以独立测试
  - 询问用户是否有问题

### 阶段 5：文档和清理

- [ ] 19. 更新架构文档
  - [ ] 19.1 更新 docs/architecture.md
    - 反映新的目录结构
    - 更新模块依赖关系图
    - 更新业务流程图
    - _需求：12.3, 12.4_
  
  - [ ] 19.2 更新 README.md
    - 更新项目结构说明
    - 更新开发指南
    - _需求：12.3_

- [ ] 20. 编写迁移指南
  - [ ] 20.1 创建 docs/refactoring-migration-guide.md
    - 说明目录结构变更
    - 说明模块路径变更
    - 说明函数名称变更
    - 提供迁移示例
    - _需求：9.4, 9.5_
  
  - [ ] 20.2 标注兼容性变更
    - 在文档中标注所有兼容性变更
    - 说明兼容性导出的使用方法
    - _需求：9.4_

- [ ] 21. 生成依赖关系图
  - [ ] 21.1 使用工具生成模块依赖关系图
    - 生成可视化的依赖关系图
    - 保存到 docs/images/
    - _需求：12.4_
  
  - [ ] 21.2 在文档中引用依赖关系图
    - 在 architecture.md 中引用
    - 添加说明文字
    - _需求：12.4_

- [ ] 22. 编写重构总结
  - [ ] 22.1 创建 docs/refactoring-summary.md
    - 总结重构的目标和成果
    - 列出主要变更
    - 提供重构前后的对比
    - _需求：12.5_
  
  - [ ] 22.2 记录经验教训
    - 记录重构过程中的问题和解决方案
    - 记录最佳实践
    - _需求：12.5_

- [ ] 23. 最终验证
  - [ ] 23.1 运行完整测试套件
    - 确保所有测试通过
    - 确保测试覆盖率达标
    - _需求：8.4, 11.5_
  
  - [ ] 23.2 验证所有正确性属性
    - 验证代码行数限制
    - 验证无循环依赖
    - 验证目录层级限制
    - 验证目录说明文档完整性
    - 验证 API 接口向后兼容
    - 验证系统行为一致性
    - 验证模块路径兼容性
    - 验证函数别名兼容性
    - 验证测试文件覆盖
    - 验证公共接口测试覆盖
    - 验证测试覆盖率达标
    - _需求：3.2, 3.3, 4.2, 4.3, 8.1, 8.5, 9.2, 9.3, 11.1, 11.2, 11.3_
  
  - [ ] 23.3 进行手工测试
    - 测试需求提交流程
    - 测试智能体创建和协作
    - 测试工件存储和检索
    - _需求：8.5_

- [ ] 24. 检查点 - 重构完成
  - 确保所有测试通过
  - 确保所有文档完整
  - 确保代码整洁
  - 询问用户是否满意

## 注意事项

1. **标记说明**：
   - `- [ ]` 表示未完成的任务
   - `- [ ]*` 表示可选任务（测试相关）
   - `_需求：X.Y_` 表示该任务对应的需求编号

2. **执行顺序**：
   - 必须按阶段顺序执行
   - 每个阶段完成后必须通过检查点
   - 可选任务可以跳过，但建议完成以确保质量

3. **测试要求**：
   - 每次文件移动或代码修改后都要运行测试
   - 确保测试覆盖率不降低
   - 发现问题立即修复

4. **兼容性要求**：
   - 所有路径变更都要提供兼容性导出
   - 所有函数名称变更都要提供别名导出
   - 兼容性代码至少保留一个大版本

5. **文档要求**：
   - 每个模块都要有清晰的注释
   - 每个目录都要有说明文档
   - 重要变更都要在迁移指南中说明
