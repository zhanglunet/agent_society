# 设计文档：工件管理器

## 概述

工件管理器是一个集成到现有Agent Society网页界面中的新功能模块。它提供了一个专门的界面来浏览、搜索、过滤和检查由智能体生成的工件。系统根据文件类型自动选择合适的查看器，并针对每种类型进行了性能优化。

## 架构

### 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    工件管理器界面                              │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │ 工件列表面板  │  │ 搜索/过滤栏  │  │ 查看器选择   │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────┐   │
│  │              工件查看器容器                            │   │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐       │   │
│  │  │JSON查看器  │ │文本查看器  │ │图片查看器  │       │   │
│  │  └────────────┘ └────────────┘ └────────────┘       │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 数据流

```
工件存储 (artifact_store.js)
    ↓
API 端点 (HTTP GET /api/artifacts)
    ↓
前端 API 模块 (js/api.js)
    ↓
工件管理器组件 (js/components/artifact-manager.js)
    ↓
查看器组件 (JSON/Text/Image Viewer)
    ↓
用户界面
```

## 组件和接口

### 1. 工件管理器主组件 (ArtifactManager)

**职责：**
- 管理工件列表的加载和显示
- 处理搜索和过滤逻辑
- 协调查看器的切换
- 管理工件元数据和源消息追踪

**主要方法：**
```javascript
class ArtifactManager {
  // 初始化管理器
  async init()
  
  // 加载所有工件
  async loadArtifacts()
  
  // 搜索工件
  filterArtifacts(searchQuery, extensionFilter)
  
  // 选择工件并显示
  async selectArtifact(artifactId)
  
  // 获取适当的查看器
  getViewerForArtifact(artifact)
  
  // 导航到源消息
  navigateToSourceMessage(messageId)
}
```

### 2. JSON查看器 (JSONViewer)

**职责：**
- 解析和显示JSON数据
- 实现树状视图展开/折叠
- 字符串截断和工具提示
- 复制功能（对象、字段名、字段值）

**关键特性：**
- 最大字符串长度：100字符
- 支持嵌套对象和数组
- 右键上下文菜单
- 性能优化：虚拟滚动（如果树很深）

**主要方法：**
```javascript
class JSONViewer {
  // 渲染JSON树
  render(jsonData)
  
  // 展开/折叠节点
  toggleNode(nodeId)
  
  // 复制到剪贴板
  copyToClipboard(content, type)
  
  // 截断长字符串
  truncateString(str, maxLength)
  
  // 显示完整字符串工具提示
  showTooltip(element, fullString)
}
```

### 3. 文本查看器 (TextViewer)

**职责：**
- 显示纯文本内容
- 提供行号
- 实现虚拟化以处理大文件
- 支持文本选择和复制

**关键特性：**
- 行号显示
- 虚拟滚动（处理大文件）
- 代码高亮（可选）
- 换行符和缩进保留

**主要方法：**
```javascript
class TextViewer {
  // 渲染文本内容
  render(textContent)
  
  // 虚拟滚动处理
  handleScroll(scrollTop)
  
  // 计算可见行范围
  getVisibleLineRange(scrollTop, containerHeight)
  
  // 渲染可见行
  renderVisibleLines(startLine, endLine)
}
```

### 4. 图片查看器 (ImageViewer)

**职责：**
- 显示图片缩略图
- 实现灯箱全尺寸预览
- 提供缩放控件
- 支持图片导航

**关键特性：**
- 缩略图异步加载
- 灯箱模式
- 缩放功能（放大、缩小、适应窗口）
- 图片元数据显示
- 键盘导航（Escape关闭，箭头键切换）

**主要方法：**
```javascript
class ImageViewer {
  // 渲染缩略图
  renderThumbnail(imagePath)
  
  // 打开灯箱
  openLightbox(imagePath)
  
  // 关闭灯箱
  closeLightbox()
  
  // 缩放图片
  zoomImage(factor)
  
  // 适应窗口
  fitToWindow()
  
  // 导航到下一个/上一个图片
  navigateImage(direction)
}
```

### 5. 工件列表组件 (ArtifactList)

**职责：**
- 显示工件列表
- 处理工件选择
- 显示工件元数据
- 支持分页或延迟加载

**主要方法：**
```javascript
class ArtifactList {
  // 渲染工件列表
  render(artifacts)
  
  // 处理工件选择
  selectArtifact(artifactId)
  
  // 更新列表（搜索/过滤后）
  updateList(artifacts)
  
  // 实现延迟加载
  loadMoreArtifacts()
}
```

## 数据模型

### 工件数据结构

```javascript
{
  id: "uuid",                    // 工件唯一标识
  createdAt: "ISO8601",          // 创建时间
  type: "json|text|image",       // 工件类型
  content: any,                  // 工件内容
  meta: {
    filename: "string",          // 文件名
    size: number,                // 文件大小（字节）
    extension: "string",         // 文件扩展名
    messageId: "string|null",    // 生成工件的消息ID
    mimeType: "string"           // MIME类型
  }
}
```

### 工件元数据

```javascript
{
  filename: "artifact_20250109.json",
  size: 2048,
  extension: "json",
  messageId: "msg_12345",        // 用于源追踪
  mimeType: "application/json",
  createdAt: "2025-01-09T10:00:00Z"
}
```

## 用户界面设计

### 布局

工件管理器将作为现有界面的一个新标签页或侧面板集成：

```
┌─────────────────────────────────────────────────────┐
│ 工件管理器                                            │
├──────────────────┬──────────────────────────────────┤
│  工件列表        │  工件查看器                        │
│  ┌────────────┐  │  ┌──────────────────────────┐   │
│  │ 搜索框     │  │  │                          │   │
│  ├────────────┤  │  │  JSON/文本/图片          │   │
│  │ 过滤器     │  │  │  内容显示                │   │
│  ├────────────┤  │  │                          │   │
│  │ 工件1      │  │  │  查看来源 按钮           │   │
│  │ 工件2      │  │  │                          │   │
│  │ 工件3      │  │  └──────────────────────────┘   │
│  │ ...        │  │                                  │
│  └────────────┘  │                                  │
└──────────────────┴──────────────────────────────────┘
```

### 搜索和过滤

- **搜索框**：实时搜索工件名称
- **扩展名过滤**：多选过滤器，支持 .json, .txt, .md, .png, .jpg, .jpeg, .gif, .webp
- **清除按钮**：快速清除所有过滤条件

### JSON查看器UI

```
┌─────────────────────────────────────┐
│ JSON 查看器                          │
├─────────────────────────────────────┤
│ ▼ root                              │
│   ▼ users (array[2])               │
│     ▼ [0]                          │
│       • name: "Alice" (截断...)    │
│       • email: "alice@..." (截断...) │
│     ▼ [1]                          │
│       • name: "Bob"                │
│   • version: "1.0.0"               │
│   • timestamp: "2025-01-09T..."    │
└─────────────────────────────────────┘
```

## 性能优化策略

### 1. JSON查看器性能

- **字符串截断**：限制显示长度为100字符，防止DOM膨胀
- **虚拟滚动**：对于深层嵌套的JSON，仅渲染可见节点
- **延迟渲染**：展开节点时才渲染子节点

### 2. 文本查看器性能

- **虚拟滚动**：仅渲染可见行范围
- **行缓存**：缓存已渲染的行以加快重新渲染
- **分块加载**：大文件分块加载和渲染

### 3. 图片查看器性能

- **异步加载**：缩略图异步加载，不阻塞主线程
- **图片压缩**：缩略图使用压缩版本
- **懒加载**：仅加载可见的缩略图

### 4. 工件列表性能

- **分页**：每页显示20-50个工件
- **延迟加载**：滚动到底部时加载更多
- **客户端过滤**：搜索和过滤在客户端执行，避免服务器往返

## 错误处理

### 错误场景

1. **工件加载失败**：显示错误消息，提供重试按钮
2. **不支持的文件类型**：显示"不支持的文件类型"消息
3. **源消息不存在**：禁用"查看来源"按钮，显示工具提示
4. **图片加载失败**：显示占位符和错误消息

### 错误消息

```javascript
{
  ARTIFACT_LOAD_ERROR: "无法加载工件，请重试",
  UNSUPPORTED_TYPE: "不支持的文件类型",
  SOURCE_NOT_FOUND: "源消息不存在",
  IMAGE_LOAD_ERROR: "图片加载失败"
}
```

## 集成点

### 后端API

需要以下API端点：

1. **GET /api/artifacts**
   - 返回所有工件列表
   - 支持分页参数：?page=1&limit=50
   - 返回工件元数据（不包含完整内容）

2. **GET /api/artifacts/:id**
   - 返回单个工件的完整内容
   - 支持不同的格式：JSON、文本、二进制

3. **GET /api/artifacts/:id/metadata**
   - 返回工件元数据
   - 包括messageId用于源追踪

### 前端集成

- 在现有的 `web/js/app.js` 中添加工件管理器初始化
- 在 `web/index.html` 中添加工件管理器UI容器
- 在 `web/css/style.css` 中添加工件管理器样式

## 正确性属性

一个属性是一个特征或行为，应该在系统的所有有效执行中保持真实——本质上是关于系统应该做什么的正式陈述。属性充当人类可读规范和机器可验证的正确性保证之间的桥梁。

### 属性1：工件列表完整性

**对于任何**工件列表，显示的工件应该与源工件列表完全相同（相同的ID、元数据和顺序）。

**验证：需求 1.1, 1.2**

### 属性2：过滤结果一致性

**对于任何**选定的文件扩展名集合和工件列表，返回的工件应该都具有与选定扩展名之一匹配的扩展名。

**验证：需求 2.2, 2.3**

### 属性3：过滤清除往返

**对于任何**工件列表和应用的过滤条件，清除过滤后应该返回到原始的完整工件列表。

**验证：需求 2.4**

### 属性4：搜索结果一致性

**对于任何**搜索查询和工件列表，返回的工件应该都包含查询字符串在其文件名中（不区分大小写）。

**验证：需求 3.2**

### 属性5：搜索清除往返

**对于任何**工件列表和搜索查询，清除搜索字段后应该返回到原始的完整工件列表（遵守活跃的过滤条件）。

**验证：需求 3.4**

### 属性6：搜索结果高亮

**对于任何**搜索查询和匹配的工件，显示的文件名中应该标记或高亮显示匹配的查询字符串。

**验证：需求 3.3**

### 属性7：JSON树展开/折叠幂等性

**对于任何** JSON树节点，展开然后折叠应该返回到原始状态，再次展开应该显示相同的内容。

**验证：需求 4.5**

### 属性8：字符串截断一致性

**对于任何**长度超过100字符的字符串，截断后的显示应该以省略号结尾，完整字符串应该在工具提示中可用。

**验证：需求 4.3, 4.4**

### 属性9：JSON对象复制正确性

**对于任何** JSON对象，复制到剪贴板的内容应该是有效的JSON，并且反序列化后应该与原始对象相同。

**验证：需求 4.7**

### 属性10：JSON字段名复制正确性

**对于任何** JSON字段名，复制到剪贴板的内容应该与原始字段名完全相同。

**验证：需求 4.8**

### 属性11：JSON字段值复制正确性

**对于任何** JSON字段值，复制到剪贴板的内容应该与原始字段值完全相同（对于对象/数组，应该是有效的JSON）。

**验证：需求 4.9**

### 属性12：文本内容保留

**对于任何**文本工件，显示的内容应该与原始文件内容完全相同，包括所有换行符和缩进。

**验证：需求 5.1, 5.2**

### 属性13：查看器选择正确性

**对于任何**工件，根据其文件扩展名选择的查看器应该与该扩展名的预期查看器相匹配：
- .json → JSON查看器
- .txt → 文本查看器
- .md → 文本查看器
- .png, .jpg, .jpeg, .gif, .webp → 图片查看器

**验证：需求 7.1, 7.2, 7.3, 7.4, 7.5**

### 属性14：图片缩略图显示

**对于任何**图片工件，应该显示图片的缩略图。

**验证：需求 6.1**

### 属性15：灯箱打开

**对于任何**显示的图片缩略图，单击应该打开灯箱显示全尺寸图片。

**验证：需求 6.2**

### 属性16：灯箱关闭

**对于任何**打开的灯箱，通过单击图片外部或按Escape键应该关闭灯箱。

**验证：需求 6.5**

### 属性17：图片元数据显示

**对于任何**图片工件，显示的元数据（尺寸、文件大小）应该与实际图片属性相匹配。

**验证：需求 6.4**

### 属性18：图片导航

**对于任何**灯箱中的图片列表，应该能够导航到下一个或上一个图片。

**验证：需求 6.6**

### 属性19：源消息追踪

**对于任何**具有有效messageId的工件，点击"查看来源"应该导航到包含该消息ID的对话视图。

**验证：需求 9.3**

### 属性20：源消息高亮

**对于任何**导航到的源消息，应该高亮或聚焦生成工件的消息。

**验证：需求 9.4**

### 属性21：过滤和搜索组合

**对于任何**同时应用的搜索查询和扩展名过滤，返回的工件应该同时满足两个条件（文件名匹配AND扩展名匹配）。

**验证：需求 2.2, 3.2**

## 测试策略

### 单元测试

- 搜索和过滤逻辑
- 字符串截断函数
- JSON树遍历和展开/折叠
- 文件类型检测
- 复制功能

### 属性测试

- 搜索结果一致性（属性1）
- 过滤结果一致性（属性2）
- JSON树幂等性（属性3）
- 字符串截断一致性（属性4）
- 复制功能正确性（属性5）
- 查看器选择正确性（属性6）
- 文本内容保留（属性7）
- 图片元数据显示（属性8）
- 源消息追踪（属性9）
- 过滤和搜索组合（属性10）

### 集成测试

- 工件加载和显示
- 查看器切换
- 搜索和过滤交互
- 源消息导航
- 错误处理

### 性能测试

- 大型JSON文件渲染
- 大型文本文件虚拟滚动
- 图片缩略图加载
- 工件列表分页

## 技术栈

- **前端框架**：原生JavaScript（无框架依赖）
- **样式**：CSS3（与现有样式系统一致）
- **JSON处理**：原生JSON API
- **图片处理**：HTML5 Canvas（可选，用于缩放）
- **性能优化**：虚拟滚动库（可选）

## 依赖关系

- 现有的 `web/js/api.js` 模块
- 现有的 `web/css/style.css` 样式系统
- 后端工件存储API
- 消息系统（用于源追踪）
