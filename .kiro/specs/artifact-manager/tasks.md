# 实现计划：工件管理器

## 概述

工件管理器的实现分为以下阶段：
1. 后端API和数据准备
2. 核心UI组件和布局
3. 工件列表和搜索/过滤功能
4. JSON查看器实现
5. 文本查看器实现
6. 图片查看器实现
7. 源消息追踪功能
8. 性能优化和测试

## 任务列表

- [x] 1. 后端API准备和工件元数据增强
  - 在工件存储中添加messageId字段支持
  - 创建 GET /api/artifacts 端点，返回工件列表（分页）
  - 创建 GET /api/artifacts/:id 端点，返回单个工件内容
  - 创建 GET /api/artifacts/:id/metadata 端点，返回工件元数据
  - _需求: 1.1, 1.2, 9.1_

- [x] 2. 工件管理器主组件框架
  - 创建 web/js/components/artifact-manager.js
  - 实现 ArtifactManager 类和基本初始化
  - 创建工件管理器UI容器和基本布局
  - 在 web/index.html 中添加工件管理器容器
  - _需求: 1.1, 1.4_

- [x] 2.1 为工件管理器主组件编写属性测试
  - **属性1：工件列表完整性**
  - **验证：需求 1.1, 1.2**

- [x] 3. 工件列表组件实现
  - 创建 web/js/components/artifact-list.js
  - 实现工件列表渲染
  - 实现工件选择功能
  - 显示工件元数据（文件名、创建日期、文件大小）
  - _需求: 1.1, 1.2, 1.4_

- [x] 3.1 为工件列表编写单元测试
  - 测试工件列表渲染
  - 测试工件选择
  - 测试元数据显示

- [x] 4. 搜索功能实现
  - 创建 web/js/utils/artifact-search.js
  - 实现搜索逻辑（按文件名匹配）
  - 实现搜索结果高亮
  - 集成搜索到工件管理器
  - _需求: 3.1, 3.2, 3.3, 3.4_

- [x] 4.1 为搜索功能编写属性测试
  - **属性4：搜索结果一致性**
  - **属性5：搜索清除往返**
  - **属性6：搜索结果高亮**
  - **验证：需求 3.2, 3.3, 3.4**

- [x] 5. 过滤功能实现
  - 创建 web/js/utils/artifact-filter.js
  - 实现按扩展名过滤逻辑
  - 实现多扩展名选择
  - 集成过滤到工件管理器
  - _需求: 2.1, 2.2, 2.3, 2.4_

- [x] 5.1 为过滤功能编写属性测试
  - **属性2：过滤结果一致性**
  - **属性3：过滤清除往返**
  - **属性21：过滤和搜索组合**
  - **验证：需求 2.2, 2.3, 2.4**

- [x] 6. 文件类型检测和查看器选择
  - 创建 web/js/utils/file-type-detector.js
  - 实现文件类型检测逻辑
  - 实现查看器选择逻辑
  - _需求: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6_

- [x] 6.1 为查看器选择编写属性测试
  - **属性13：查看器选择正确性**
  - **验证：需求 7.1, 7.2, 7.3, 7.4, 7.5**

- [x] 7. JSON查看器实现
  - 创建 web/js/components/json-viewer.js
  - 实现JSON解析和树状视图渲染
  - 实现展开/折叠功能
  - 实现字符串截断（100字符限制）
  - 实现工具提示显示完整字符串
  - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 7.1 为JSON查看器编写属性测试
  - **属性7：JSON树展开/折叠幂等性**
  - **属性8：字符串截断一致性**
  - **验证：需求 4.3, 4.4, 4.5**

- [x] 8. JSON复制功能实现
  - 在JSON查看器中实现右键上下文菜单
  - 实现"复制对象"功能
  - 实现"复制字段名"功能
  - 实现"复制字段值"功能
  - _需求: 4.6, 4.7, 4.8, 4.9_

- [x] 8.1 为JSON复制功能编写属性测试
  - **属性9：JSON对象复制正确性**
  - **属性10：JSON字段名复制正确性**
  - **属性11：JSON字段值复制正确性**
  - **验证：需求 4.7, 4.8, 4.9**

- [x] 9. 文本查看器实现
  - 创建 web/js/components/text-viewer.js
  - 实现文本内容显示
  - 实现行号显示
  - 实现虚拟滚动（处理大文件）
  - 保留格式（换行符、缩进）
  - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 9.1 为文本查看器编写属性测试
  - **属性12：文本内容保留**
  - **验证：需求 5.1, 5.2**

- [x] 10. 图片查看器实现
  - 创建 web/js/components/image-viewer.js
  - 实现缩略图显示
  - 实现灯箱功能
  - 实现缩放控件（放大、缩小、适应窗口）
  - 显示图片元数据（尺寸、文件大小）
  - _需求: 6.1, 6.2, 6.3, 6.4_

- [x] 10.1 为图片查看器编写属性测试
  - **属性14：图片缩略图显示**
  - **属性15：灯箱打开**
  - **属性17：图片元数据显示**
  - **验证：需求 6.1, 6.2, 6.4**

- [x] 11. 灯箱关闭和导航功能
  - 实现灯箱关闭（点击外部或Escape键）
  - 实现图片导航（上一个/下一个）
  - _需求: 6.5, 6.6_

- [x] 11.1 为灯箱功能编写属性测试
  - **属性16：灯箱关闭**
  - **属性18：图片导航**
  - **验证：需求 6.5, 6.6**

- [x] 12. 源消息追踪功能实现
  - 在工件管理器中添加"查看来源"按钮
  - 实现源消息导航逻辑
  - 处理没有messageId的情况（禁用按钮）
  - 实现消息高亮/聚焦
  - _需求: 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 12.1 为源消息追踪编写属性测试
  - **属性19：源消息追踪**
  - **属性20：源消息高亮**
  - **验证：需求 9.3, 9.4**

- [x] 13. 样式和UI优化
  - 在 web/css/style.css 中添加工件管理器样式
  - 实现响应式设计
  - 优化深色主题适配
  - 添加加载状态和错误状态样式
  - _需求: 1.1, 2.1, 3.1, 4.1, 5.1, 6.1_

- [x] 14. 错误处理和边界情况
  - 处理空工件列表
  - 处理搜索/过滤无结果
  - 处理不支持的文件类型
  - 处理工件加载失败
  - 处理图片加载失败
  - _需求: 1.3, 2.5, 3.5, 7.6_

- [x] 14.1 为边界情况编写单元测试
  - 测试空工件列表
  - 测试搜索无结果
  - 测试不支持的文件类型
  - 测试缺少messageId的工件

- [x] 15. 性能优化
  - 实现工件列表分页/延迟加载
  - 优化JSON查看器虚拟滚动
  - 优化文本查看器虚拟滚动
  - 异步加载图片缩略图
  - _需求: 8.1, 8.2, 8.3, 8.4, 8.5_

- [x] 16. 集成测试
  - 测试工件加载和显示
  - 测试搜索和过滤交互
  - 测试查看器切换
  - 测试源消息导航
  - 测试完整的用户工作流
  - _需求: 1.1, 1.4, 3.2, 2.2, 7.1, 9.3_

- [x] 17. 最终检查点 - 确保所有测试通过
  - 运行所有属性测试
  - 运行所有单元测试
  - 运行集成测试
  - 验证性能指标
  - 如有问题，请咨询用户

## 注意事项

- 所有任务都是必需的，包括完整的属性测试和单元测试
- 每个任务都引用了特定的需求，以便追踪
- 属性测试应该使用 fast-check 库（已在 package.json 中）
- 所有代码应该遵循现有的代码风格和约定
- 确保与现有的Agent Society界面无缝集成
