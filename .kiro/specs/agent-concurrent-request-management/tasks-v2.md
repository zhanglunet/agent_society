# 实现计划：智能体并发请求管理（简化版）

## 概述

本实现计划将并发请求管理功能分解为简单的编码任务。核心策略是在工具调用前检查插话，如果有插话则删除最后一条assistant消息并追加插话内容。

## 任务列表

### 阶段1：基础设施

- [x] 1. 在Runtime中添加插话队列管理
  - 添加 `_interruptionQueues` Map
  - 实现 `addInterruption(agentId, message)` 方法
  - 实现 `getAndClearInterruptions(agentId)` 方法
  - 添加日志记录
  - _需求: 1.1, 4.1, 4.2, 4.3, 4.4_

- [x] 1.1 为插话队列管理编写单元测试
  - 测试添加插话消息
  - 测试获取并清空插话队列
  - 测试FIFO顺序
  - 测试空队列情况

### 阶段2：MessageBus集成

- [x] 2. 修改MessageBus检测活跃智能体并触发插话
  - 在 `send()` 中检查智能体是否活跃
  - 调用 `onInterruptionNeeded` 回调
  - 保持现有消息入队行为
  - _需求: 1.1, 1.4_

- [x] 2.1 为MessageBus插话检测编写单元测试
  - 测试活跃智能体触发插话回调
  - 测试非活跃智能体不触发
  - 测试回调错误处理

### 阶段3：LlmHandler插话处理

- [x] 3. 在LlmHandler中实现插话检查和处理
  - 实现 `checkAndHandleInterruptions(agentId, conv, ctx)` 方法
  - 删除最后一条assistant消息（如果包含tool_calls）
  - 追加所有插话消息到对话历史
  - 返回是否有插话被处理
  - _需求: 2.1, 2.2, 2.3, 2.4, 5.1, 5.2, 5.3, 5.4_

- [x] 3.1 为插话处理编写单元测试
  - 测试无插话时返回false
  - 测试有插话时删除assistant消息
  - 测试插话消息追加到对话历史
  - 测试最后一条消息不是assistant的情况
  - 测试空对话历史的情况

### 阶段4：工具调用循环集成

- [x] 4. 修改doLlmProcessing添加插话检查点
  - 在循环开始时标记智能体为活跃
  - 在工具调用前检查插话
  - 在LLM完成回复时检查插话
  - 在finally块中标记智能体为空闲
  - _需求: 1.2, 1.3, 2.1, 2.4, 3.1, 3.2, 3.3_

- [x] 4.1 为工具调用循环集成编写单元测试
  - 测试智能体活跃状态管理 ✓
  - 测试工具调用前插话检查 ✓
  - 测试LLM完成时插话检查 ✓
  - 测试异常情况下的状态清理 ✓
  - 测试多次插话处理 ✓
  - 测试用户中断时状态清理 ✓
  - 测试finally块确保状态清理 ✓

### 阶段5：Runtime回调集成

- [x] 5. 在Runtime初始化时设置MessageBus回调
  - 传递 `isAgentActivelyProcessing` 回调
  - 传递 `onInterruptionNeeded` 回调
  - 在回调中调用 `addInterruption()`
  - _需求: 1.1, 1.4, 4.1_

- [x] 5.1 为Runtime回调集成编写单元测试
  - 回调已在MessageBus测试中验证
  - 插话队列管理已在Runtime测试中验证

### 阶段6：集成测试

- [ ] 6. 编写端到端集成测试
  - 测试完整插话流程（智能体处理中收到插话）
  - 测试工具调用前插话
  - 测试LLM完成后插话
  - 测试多次连续插话
  - 测试对话历史正确性
  - _需求: 1.1, 2.1, 3.1, 4.1, 5.1, 6.1_

- [ ] 6.1 编写边界情况测试
  - 测试空对话历史时插话
  - 测试最后一条消息不是assistant时插话
  - 测试插话队列为空的情况
  - 测试智能体空闲时收到消息

### 阶段7：状态一致性验证

- [ ] 7. 添加状态一致性检查
  - 验证活跃智能体注册表与实际状态一致
  - 验证插话队列在智能体空闲时为空
  - 添加状态不一致的日志和恢复逻辑
  - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 7.1 为状态一致性编写测试
  - 测试正常情况下的状态一致性
  - 测试异常情况下的状态恢复
  - 测试状态不一致的检测

### 阶段8：最终验证

- [ ] 8. 运行所有测试确保功能正确
  - 运行所有单元测试
  - 运行所有集成测试
  - 验证无回归
  - 验证性能要求（插话检查 < 10ms）

- [ ] 9. 代码审查和文档更新
  - 添加代码注释
  - 更新相关文档
  - 确保代码符合项目规范

## 注意事项

1. **简单性优先**：保持实现简单，不引入不必要的复杂性
2. **最小侵入**：只修改必要的代码，不改变现有架构
3. **向后兼容**：确保不影响现有功能
4. **充分测试**：每个功能都要有对应的测试
5. **清晰日志**：添加足够的日志以便调试

## 实现顺序说明

任务按照依赖关系排序：
1. 先实现基础设施（插话队列）
2. 再实现MessageBus集成（检测活跃智能体）
3. 然后实现LlmHandler插话处理（核心逻辑）
4. 最后集成到工具调用循环
5. 进行全面测试和验证

每个阶段完成后都应该运行相关测试，确保功能正确再进入下一阶段。
